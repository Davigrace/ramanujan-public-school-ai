<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ramanujan School AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1220;
      --card:#161a35;
      --accent:#6cf2c2;
      --accent2:#7aa2ff;
      --text:#e7e9ff;
      --muted:#aab0ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        linear-gradient(rgba(15,18,32,.75), rgba(15,18,32,.75)),
        url('assets/images/bg.png') center/cover no-repeat;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .app{
      width:min(980px, 94vw); 
      height:min(620px, 90vh);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
                 var(--card);
      border-radius:22px; 
      box-shadow:0 30px 80px rgba(0,0,0,.45);
      display:grid; 
      grid-template-rows:auto 1fr auto; 
      overflow:hidden;
      position:relative;
    }
    header{
      padding:18px 22px; 
      display:flex; 
      align-items:center; 
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .logo{
      width:38px; 
      height:38px; 
      border-radius:10px;
      background:rgba(255,255,255,.9);
      display:grid; 
      place-items:center;
      overflow:hidden;
    }
    .logo img{
      width:100%; 
      height:100%; 
      object-fit:contain;
    }
    header h1{
      font-size:18px; 
      margin:0;
    }
    header span{
      color:var(--muted); 
      font-size:13px;
    }
    
    /* API Key Button in Header */
    .api-key-btn{
      margin-left:auto;
      background:rgba(108, 242, 194, 0.1);
      border:1px solid rgba(108, 242, 194, 0.3);
      color:var(--accent);
      padding:6px 12px;
      border-radius:8px;
      font-size:12px;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .api-key-btn:hover{
      background:rgba(108, 242, 194, 0.2);
    }

    .chat{
      padding:18px; 
      overflow:auto;
    }
    .msg{
      max-width:78%; 
      margin-bottom:14px; 
      padding:12px 14px; 
      border-radius:14px; 
      line-height:1.45;
      word-wrap:break-word;
    }
    .user{
      margin-left:auto; 
      background:linear-gradient(135deg, #2a3170, #2d3aa6);
    }
    .ai{
      background:#202661;
    }

    footer{
      padding:14px; 
      border-top:1px solid rgba(255,255,255,.08);
    }
    .input{
      display:flex; 
      gap:10px; 
      align-items:center;
      background:#0e1230; 
      padding:10px; 
      border-radius:14px;
    }
    input{
      flex:1; 
      background:transparent; 
      border:none; 
      outline:none; 
      color:var(--text);
      font-size:14px;
    }
    button{
      border:none; 
      cursor:pointer; 
      padding:10px 14px; 
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071515; 
      font-weight:700;
      transition:opacity 0.3s ease;
    }
    button:hover{
      opacity:0.9;
    }
    button:disabled{
      opacity:.6; 
      cursor:not-allowed;
    }
    .hint{
      font-size:12px; 
      color:var(--muted); 
      margin-top:6px;
    }

    /* API KEY DIALOG - Integrated into site */
    .api-dialog{
      position:absolute;
      top:70px;
      right:20px;
      background:var(--card);
      padding:20px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 10px 40px rgba(0,0,0,.5);
      width:320px;
      z-index:100;
      display:none;
    }
    .api-dialog.show{
      display:block;
      animation:fadeIn 0.3s ease;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(-10px);}
      to{opacity:1; transform:translateY(0);}
    }
    .api-dialog h3{
      margin:0 0 15px 0;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .api-dialog h3:before{
      content:"ðŸ”‘";
      font-size:14px;
    }
    .api-input-container{
      display:flex;
      gap:10px;
      margin-bottom:12px;
    }
    .api-input{
      flex:1;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:8px;
      padding:10px 12px;
      color:var(--text);
      font-size:13px;
      font-family:monospace;
    }
    .api-input:focus{
      outline:none;
      border-color:var(--accent);
    }
    .api-status{
      font-size:12px;
      margin-bottom:15px;
      padding:8px;
      border-radius:6px;
      background:rgba(255,255,255,.05);
    }
    .api-status.valid{
      color:var(--accent);
      background:rgba(108, 242, 194, 0.1);
    }
    .api-status.invalid{
      color:#ff7a7a;
      background:rgba(255, 122, 122, 0.1);
    }
    .api-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .api-actions button{
      padding:8px 16px;
      font-size:12px;
    }
    .api-actions .secondary{
      background:rgba(255,255,255,.1);
      color:var(--text);
    }
    .api-actions .secondary:hover{
      background:rgba(255,255,255,.15);
    }
    .api-help{
      font-size:11px;
      color:var(--muted);
      margin-top:12px;
      line-height:1.4;
    }
    .api-help a{
      color:var(--accent);
      text-decoration:none;
    }
    .api-help a:hover{
      text-decoration:underline;
    }
    
    /* Loading animation */
    .typing-indicator{
      display:flex;
      gap:4px;
      padding:8px 12px;
    }
    .typing-indicator span{
      width:8px;
      height:8px;
      background:var(--accent);
      border-radius:50%;
      animation:typing 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1){animation-delay:-0.32s;}
    .typing-indicator span:nth-child(2){animation-delay:-0.16s;}
    @keyframes typing{
      0%, 80%, 100%{transform:scale(0.6); opacity:0.3;}
      40%{transform:scale(1); opacity:1;}
    }
    
    /* Close button for dialog */
    .close-dialog{
      position:absolute;
      top:12px;
      right:12px;
      background:none;
      border:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      transition:all 0.3s ease;
    }
    .close-dialog:hover{
      background:rgba(255,255,255,.1);
      color:var(--text);
    }
    
    /* Warning message */
    .warning-msg {
      background: rgba(255, 193, 7, 0.1);
      border-left: 3px solid #ffc107;
      padding: 10px 14px;
      margin: 10px 0;
      border-radius: 0 8px 8px 0;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="app">
  <!-- API Key Dialog (integrated into site) -->
  <div id="apiDialog" class="api-dialog">
    <button class="close-dialog" id="closeDialog">Ã—</button>
    <h3>Gemini API Key</h3>
    
    <div class="api-input-container">
      <input type="password" id="apiInput" class="api-input" placeholder="Enter your API key..." />
      <button id="saveKey" class="small">Save</button>
    </div>
    
    <div id="apiStatus" class="api-status">
      Status: No API key saved
    </div>
    
    <div class="api-actions">
      <button id="clearKey" class="secondary">Clear Key</button>
      <button id="testKey" class="secondary">Test Key</button>
      <button id="listModels" class="secondary">List Models</button>
    </div>
    
    <div class="api-help">
      Get your free API key from 
      <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>. 
      Free tier: ~20 requests/day. Keys are stored locally.
    </div>
  </div>

  <header>
    <div class="logo"><img src="assets/images/logo.png" alt="School Logo"></div>
    <div>
      <h1>Ramanujan School AI</h1>
      <span>Homework help â€¢ Concepts â€¢ Practice</span>
    </div>
    <button class="api-key-btn" id="openApiDialog">
      ðŸ”‘ API Key
    </button>
  </header>

  <div id="chat" class="chat">
    <div class="msg ai">Hello! I'm Ramanujan School AI. Ask me any school question ðŸ™‚</div>
    <div class="warning-msg">
      <strong>Note:</strong> Using free Google AI Studio tier (~20 requests/day). For higher limits, consider alternatives like Groq or OpenRouter.
    </div>
  </div>

  <footer>
    <div class="input">
      <input id="q" placeholder="Type your question..." />
      <button id="send">Send</button>
    </div>
    <div class="hint">
      <span id="modeIndicator">ðŸ”´ Offline Mode</span> â€¢ Free Tier: ~20 requests/day
    </div>
  </footer>
</div>

<script>
  /* ======================================================
     API KEY HANDLING
  ====================================================== */
  let GEMINI_KEY = localStorage.getItem('GEMINI_API_KEY');
  const dialog = document.getElementById('apiDialog');
  const openBtn = document.getElementById('openApiDialog');
  const closeBtn = document.getElementById('closeDialog');
  const apiInput = document.getElementById('apiInput');
  const saveKey = document.getElementById('saveKey');
  const clearKey = document.getElementById('clearKey');
  const testKey = document.getElementById('testKey');
  const listModelsBtn = document.getElementById('listModels');
  const apiStatus = document.getElementById('apiStatus');
  const modeIndicator = document.getElementById('modeIndicator');

  // Update status display
  function updateApiStatus() {
    if (GEMINI_KEY) {
      // Show first 10 and last 4 characters of key for verification
      const maskedKey = `${GEMINI_KEY.substring(0, 10)}...${GEMINI_KEY.substring(GEMINI_KEY.length - 4)}`;
      apiStatus.textContent = `âœ… API Key saved: ${maskedKey}`;
      apiStatus.className = 'api-status valid';
      modeIndicator.textContent = 'ðŸŸ¢ Online Mode (Free Tier)';
      modeIndicator.style.color = '#6cf2c2';
    } else {
      apiStatus.textContent = 'ðŸ”´ No API key saved (Offline mode only)';
      apiStatus.className = 'api-status invalid';
      modeIndicator.textContent = 'ðŸ”´ Offline Mode';
      modeIndicator.style.color = '#ff7a7a';
    }
  }

  // Initialize status
  updateApiStatus();

  // Open/close dialog
  openBtn.onclick = (e) => {
    e.stopPropagation();
    dialog.classList.toggle('show');
    if (dialog.classList.contains('show')) {
      apiInput.value = GEMINI_KEY || '';
      apiInput.focus();
    }
  };

  closeBtn.onclick = () => {
    dialog.classList.remove('show');
  };

  // Close dialog when clicking outside
  document.addEventListener('click', (e) => {
    if (!dialog.contains(e.target) && e.target !== openBtn) {
      dialog.classList.remove('show');
    }
  });

  // Save API key
  saveKey.onclick = () => {
    const v = apiInput.value.trim();
    if (v) {
      if (!v.startsWith('AIza')) {
        apiStatus.textContent = 'âŒ Key should start with AIza...';
        apiStatus.className = 'api-status invalid';
        return;
      }
      localStorage.setItem('GEMINI_API_KEY', v);
      GEMINI_KEY = v;
      updateApiStatus();
      dialog.classList.remove('show');
      add('API key saved successfully! You can now use online features.', 'ai');
    }
  };

  // Clear API key
  clearKey.onclick = () => {
    localStorage.removeItem('GEMINI_API_KEY');
    GEMINI_KEY = null;
    apiInput.value = '';
    updateApiStatus();
    add('API key cleared. Switching to offline mode.', 'ai');
  };

  // Test API key
  testKey.onclick = async () => {
    if (!GEMINI_KEY) {
      apiStatus.textContent = 'âŒ No API key to test';
      apiStatus.className = 'api-status invalid';
      return;
    }

    apiStatus.textContent = 'ðŸ”„ Testing API key...';
    apiStatus.className = 'api-status';

    try {
      // Using the correct model name for free tier
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              role: 'user',
              parts: [{ text: 'Say "API test successful" if you can read this.' }]
            }],
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 100
            }
          })
        }
      );

      if (response.ok) {
        apiStatus.textContent = 'âœ… API key is working!';
        apiStatus.className = 'api-status valid';
      } else {
        const error = await response.json();
        let errorMsg = `âŒ API error: ${error.error?.message || 'Unknown error'}`;
        
        // Provide helpful suggestions for common errors
        if (error.error?.message?.includes('not found') || error.error?.message?.includes('not supported')) {
          errorMsg += '. Try using "gemini-2.5-flash-lite" instead.';
        } else if (error.error?.message?.includes('quota')) {
          errorMsg += '. You may have exceeded the free tier limit (~20 requests/day).';
        }
        
        apiStatus.textContent = errorMsg;
        apiStatus.className = 'api-status invalid';
      }
    } catch (err) {
      apiStatus.textContent = 'âŒ Network error - check connection';
      apiStatus.className = 'api-status invalid';
    }
  };

  // List available models
  listModelsBtn.onclick = async () => {
    if (!GEMINI_KEY) {
      apiStatus.textContent = 'âŒ No API key to list models';
      apiStatus.className = 'api-status invalid';
      return;
    }

    apiStatus.textContent = 'ðŸ”„ Fetching available models...';
    apiStatus.className = 'api-status';

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1/models?key=${GEMINI_KEY}`
      );

      if (response.ok) {
        const data = await response.json();
        const models = data.models || [];
        
        // Filter for Gemini models that support generateContent
        const geminiModels = models.filter(model => 
          model.name.includes('gemini') && 
          model.supportedGenerationMethods && 
          model.supportedGenerationMethods.includes('generateContent')
        );
        
        if (geminiModels.length > 0) {
          const modelNames = geminiModels.map(m => m.name.split('/').pop()).join(', ');
          apiStatus.textContent = `âœ… Available Gemini models: ${modelNames}`;
          apiStatus.className = 'api-status valid';
          
          // Show in chat too
          add(`Available Gemini models for your key: ${modelNames}`, 'ai');
        } else {
          apiStatus.textContent = 'âŒ No Gemini models found with generateContent support';
          apiStatus.className = 'api-status invalid';
        }
      } else {
        const error = await response.json();
        apiStatus.textContent = `âŒ Error: ${error.error?.message || 'Unknown error'}`;
        apiStatus.className = 'api-status invalid';
      }
    } catch (err) {
      apiStatus.textContent = 'âŒ Network error - check connection';
      apiStatus.className = 'api-status invalid';
    }
  };

  // Enter key to save
  apiInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      saveKey.click();
    }
  });

  /* ======================================================
     CHAT LOGIC
  ====================================================== */
  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const send = document.getElementById('send');

  // ===== OFFLINE KNOWLEDGE BASE =====
  const JAGANNATH_KB = `
Lord Jagannath is a revered form of Lord Vishnu/Krishna, worshipped primarily in Odisha, India.
He is traditionally worshipped along with his siblings: Lord Balabhadra and Devi Subhadra.

Jagannath Puri Temple is one of the Char Dham pilgrimage sites of Hinduism and is located in Puri, Odisha.

A unique feature of Jagannath worship is the wooden idols (daru brahma), which are ritually renewed in the Nabakalebara ceremony.

The annual Rath Yatra is a major festival where the deities are taken out on massive chariots for public darshan.

Jagannath symbolizes universality, compassion, and inclusiveness.
`;

  // Math knowledge base
  const MATH_KB = {
    'pythagoras': 'The Pythagorean theorem states: aÂ² + bÂ² = cÂ², where c is the hypotenuse of a right triangle.',
    'quadratic': 'The quadratic formula: x = [-b Â± âˆš(bÂ² - 4ac)] / 2a',
    'algebra': 'Algebra is the branch of mathematics dealing with symbols and rules for manipulating those symbols.',
    'geometry': 'Geometry studies shapes, sizes, positions, and properties of space.',
    'calculus': 'Calculus is the mathematical study of continuous change.'
  };

  function isGreeting(t) { 
    return /^(hi|hello|hey|namaste|good morning|good afternoon|good evening)/i.test(t); 
  }
  
  function isHowAreYou(t) { 
    return /(how are you|how r u|how\'re you)/i.test(t); 
  }
  
  function isJagannathQuery(t) { 
    return /(jagannath|puri|rath yatra|nabakalebara|mahaprasad|balabhadra|subhadra)/i.test(t); 
  }

  function isMathQuery(t) {
    const lower = t.toLowerCase();
    for (const key in MATH_KB) {
      if (lower.includes(key)) {
        return MATH_KB[key];
      }
    }
    return null;
  }

  function offlineReply(text) {
    text = text.toLowerCase().trim();
    if (isGreeting(text)) return 'Hello! How may I assist you with your studies today?';
    if (isHowAreYou(text)) return 'I am functioning well. Ready to help with your questions!';
    if (isJagannathQuery(text)) return JAGANNATH_KB;
    
    const mathReply = isMathQuery(text);
    if (mathReply) return mathReply;
    
    if (text.includes('api') || text.includes('key')) {
      return 'You can manage your API key by clicking the "API Key" button in the top right.';
    }
    
    return null;
  }

  function add(text, cls, isTyping = false) {
    const d = document.createElement('div');
    d.className = `msg ${cls}`;
    
    if (isTyping) {
      d.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      d.id = 'typing-msg';
    } else {
      // Simple formatting for newlines
      d.textContent = text;
    }
    
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return d;
  }

  function removeTypingIndicator() {
    const typingMsg = document.getElementById('typing-msg');
    if (typingMsg) {
      typingMsg.remove();
    }
  }

  async function ask() {
    const text = q.value.trim();
    if (!text) return;

    q.value = '';
    add(text, 'user');
    send.disabled = true;
    q.disabled = true;

    // Show typing indicator for online responses
    let typingIndicator = null;
    if (!offlineReply(text)) {
      typingIndicator = add('', 'ai', true);
    }

    // ===== OFFLINE FIRST =====
    const local = offlineReply(text);
    if (local) {
      setTimeout(() => {
        removeTypingIndicator();
        add(local, 'ai');
        send.disabled = false;
        q.disabled = false;
        q.focus();
      }, 500);
      return;
    }

    // ===== ONLINE (GEMINI) =====
    // Check if API key exists
    if (!GEMINI_KEY) {
      removeTypingIndicator();
      add('To answer this question, I need to use online features. Please add your Gemini API key by clicking the "API Key" button in the top right.', 'ai');
      send.disabled = false;
      q.disabled = false;
      q.focus();
      // Open dialog to prompt for API key
      dialog.classList.add('show');
      return;
    }

    try {
      // UPDATED: Using the correct model for free tier
      const modelName = 'gemini-2.0-flash'; // Free tier model
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1/models/${modelName}:generateContent?key=${GEMINI_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              role: 'user',
              parts: [{ 
                text: `You are Ramanujan School AI, a helpful assistant for students. Answer this question clearly and concisely: ${text}` 
              }]
            }],
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 500
            }
          })
        }
      );

      removeTypingIndicator();
      
      if (!response.ok) {
        const error = await response.json();
        let errorMsg = '';
        
        // Handle specific errors with helpful messages
        if (error.error?.code === 403 || error.error?.message?.includes('API key')) {
          errorMsg = 'API key error. Please check your key is valid and has Gemini API access.';
          updateApiStatus();
        } else if (error.error?.message?.includes('not found') || error.error?.message?.includes('not supported')) {
          errorMsg = `Model "${modelName}" not found. Click "List Models" to see available options.`;
        } else if (error.error?.message?.includes('quota') || error.error?.message?.includes('resource has been exhausted')) {
          errorMsg = 'Free tier limit reached (~20 requests/day). Try again tomorrow or use offline mode.';
        } else {
          errorMsg = `Error: ${error.error?.message || 'Unknown error'}`;
        }
        
        add(errorMsg, 'ai');
      } else {
        const data = await response.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 
                     'I received an empty response. Please try again.';
        add(reply, 'ai');
      }

    } catch (err) {
      removeTypingIndicator();
      console.error('Request failed:', err);
      add('Network error. Please check your connection and try again.', 'ai');
    }

    send.disabled = false;
    q.disabled = false;
    q.focus();
  }

  // Event listeners
  send.onclick = ask;
  q.addEventListener('keydown', e => { 
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      ask();
    }
  });

  // Auto-focus input on load
  window.addEventListener('load', () => {
    q.focus();
  });
</script>
</body>
</html>

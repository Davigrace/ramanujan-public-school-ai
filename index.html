<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ramanujan School AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* [ALL YOUR ORIGINAL CSS REMAINS EXACTLY THE SAME HERE] */
    :root{
      --bg:#0f1220;
      --card:#161a35;
      --accent:#6cf2c2;
      --accent2:#7aa2ff;
      --text:#e7e9ff;
      --muted:#aab0ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        linear-gradient(rgba(15,18,32,.75), rgba(15,18,32,.75)),
        url('assets/images/bg.png') center/cover no-repeat;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .app{
      width:min(980px, 94vw);
      height:min(620px, 90vh);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
                 var(--card);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(0,0,0,.45);
      display:grid;
      grid-template-rows:auto 1fr auto;
      overflow:hidden;
      position:relative;
    }
    /* ... REST OF YOUR CSS ... */
  </style>
</head>
<body>
<div class="app">
  <!-- API Key Dialog - TEXT UPDATED FOR GROQ -->
  <div id="apiDialog" class="api-dialog">
    <button class="close-dialog" id="closeDialog">Ã—</button>
    <h3>Groq API Key</h3> <!-- Changed from "Gemini API Key" -->
    <div class="api-input-container">
      <input type="password" id="apiInput" class="api-input" placeholder="Enter your API key..." />
      <button id="saveKey" class="small">Save</button>
    </div>
    <div id="apiStatus" class="api-status">
      Status: No API key saved
    </div>
    <div class="api-actions">
      <button id="clearKey" class="secondary">Clear Key</button>
      <button id="testKey" class="secondary">Test Key</button>
    </div>
    <!-- Updated Help Text -->
    <div class="api-help">
      Get your free API key from
      <a href="https://console.groq.com" target="_blank">Groq Console</a>.
      Free tier: ~14,400 requests/day. Keys are stored locally[citation:2].
    </div>
  </div>

  <header>
    <div class="logo"><img src="assets/images/logo.png" alt="School Logo"></div>
    <div>
      <h1>Ramanujan School AI</h1>
      <span>Homework help â€¢ Concepts â€¢ Practice</span>
    </div>
    <button class="api-key-btn" id="openApiDialog">
      ðŸ”‘ API Key
    </button>
  </header>

  <div id="chat" class="chat">
    <div class="msg ai">Hello! I'm Ramanujan School AI. Ask me any school question ðŸ™‚</div>
    <!-- Updated Warning Message -->
    <div class="warning-msg">
      <strong>Note:</strong> Now powered by Groq for ultra-fast responses[citation:1]. Using free tier (~14,400 requests/day).
    </div>
  </div>

  <footer>
    <div class="input">
      <input id="q" placeholder="Type your question..." />
      <button id="send">Send</button>
    </div>
    <!-- Updated Footer Hint -->
    <div class="hint">
      <span id="modeIndicator">ðŸ”´ Offline Mode</span> â€¢ Powered by Groq (Free Tier)
    </div>
  </footer>
</div>

<script>
  /* ======================================================
     API KEY HANDLING - UPDATED FOR GROQ
  ====================================================== */
  // Changed localStorage key from 'GEMINI_API_KEY' to 'GROQ_API_KEY'
  let GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
  const dialog = document.getElementById('apiDialog');
  const openBtn = document.getElementById('openApiDialog');
  const closeBtn = document.getElementById('closeDialog');
  const apiInput = document.getElementById('apiInput');
  const saveKey = document.getElementById('saveKey');
  const clearKey = document.getElementById('clearKey');
  const testKey = document.getElementById('testKey');
  const apiStatus = document.getElementById('apiStatus');
  const modeIndicator = document.getElementById('modeIndicator');

  // Update status display
  function updateApiStatus() {
    if (GROQ_API_KEY) {
      const maskedKey = `${GROQ_API_KEY.substring(0, 10)}...${GROQ_API_KEY.substring(GROQ_API_KEY.length - 4)}`;
      apiStatus.textContent = `âœ… API Key saved: ${maskedKey}`;
      apiStatus.className = 'api-status valid';
      modeIndicator.textContent = 'ðŸŸ¢ Online Mode (Groq)';
      modeIndicator.style.color = '#6cf2c2';
    } else {
      apiStatus.textContent = 'ðŸ”´ No API key saved (Offline mode only)';
      apiStatus.className = 'api-status invalid';
      modeIndicator.textContent = 'ðŸ”´ Offline Mode';
      modeIndicator.style.color = '#ff7a7a';
    }
  }

  // Initialize status
  updateApiStatus();

  // Open/close dialog
  openBtn.onclick = (e) => {
    e.stopPropagation();
    dialog.classList.toggle('show');
    if (dialog.classList.contains('show')) {
      apiInput.value = GROQ_API_KEY || '';
      apiInput.focus();
    }
  };
  closeBtn.onclick = () => { dialog.classList.remove('show'); };
  document.addEventListener('click', (e) => {
    if (!dialog.contains(e.target) && e.target !== openBtn) { dialog.classList.remove('show'); }
  });

  // Save API key - Store as GROQ_API_KEY
  saveKey.onclick = () => {
    const v = apiInput.value.trim();
    if (v) {
      // Groq keys don't have a standard prefix like 'AIza', so we just check length
      if (v.length < 20) {
        apiStatus.textContent = 'âŒ Key seems too short. Please check.';
        apiStatus.className = 'api-status invalid';
        return;
      }
      localStorage.setItem('GROQ_API_KEY', v);
      GROQ_API_KEY = v;
      updateApiStatus();
      dialog.classList.remove('show');
      add('Groq API key saved successfully! You can now use online features.', 'ai');
    }
  };

  // Clear API key
  clearKey.onclick = () => {
    localStorage.removeItem('GROQ_API_KEY');
    GROQ_API_KEY = null;
    apiInput.value = '';
    updateApiStatus();
    add('API key cleared. Switching to offline mode.', 'ai');
  };

  // Test API key - UPDATED FOR GROQ
  testKey.onclick = async () => {
    if (!GROQ_API_KEY) {
      apiStatus.textContent = 'âŒ No API key to test';
      apiStatus.className = 'api-status invalid';
      return;
    }
    apiStatus.textContent = 'ðŸ”„ Testing Groq API key...';
    apiStatus.className = 'api-status';
    try {
      // Groq API call structure
      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${GROQ_API_KEY}` // Groq uses Bearer token
        },
        body: JSON.stringify({
          messages: [{ role: 'user', content: 'Say "API test successful" if you can read this.' }],
          model: 'llama3-70b-8192' // Default Groq model[citation:9]
        })
      });
      if (response.ok) {
        apiStatus.textContent = 'âœ… Groq API key is working!';
        apiStatus.className = 'api-status valid';
      } else {
        const error = await response.json();
        let errorMsg = `âŒ API error: ${error.error?.message || 'Unknown error'}`;
        apiStatus.textContent = errorMsg;
        apiStatus.className = 'api-status invalid';
      }
    } catch (err) {
      apiStatus.textContent = 'âŒ Network error - check connection';
      apiStatus.className = 'api-status invalid';
    }
  };
  apiInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveKey.click(); });

  /* ======================================================
     CHAT LOGIC - OFFLINE FUNCTIONS UNCHANGED
  ====================================================== */
  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const send = document.getElementById('send');

  // ===== OFFLINE KNOWLEDGE BASE =====
  const JAGANNATH_KB = `...`; // Your original text here
  const MATH_KB = { 'pythagoras': '...', 'quadratic': '...', 'algebra': '...', 'geometry': '...', 'calculus': '...' };
  function isGreeting(t) { return /^(hi|hello|hey|namaste|good morning|good afternoon|good evening)/i.test(t); }
  function isHowAreYou(t) { return /(how are you|how r u|how're you)/i.test(t); }
  function isJagannathQuery(t) { return /(jagannath|puri|rath yatra|nabakalebara|mahaprasad|balabhadra|subhadra)/i.test(t); }
  function isMathQuery(t) {
    const lower = t.toLowerCase();
    for (const key in MATH_KB) { if (lower.includes(key)) return MATH_KB[key]; }
    return null;
  }
  function offlineReply(text) {
    text = text.toLowerCase().trim();
    if (isGreeting(text)) return 'Hello! How may I assist you with your studies today?';
    if (isHowAreYou(text)) return 'I am functioning well. Ready to help with your questions!';
    if (isJagannathQuery(text)) return JAGANNATH_KB;
    const mathReply = isMathQuery(text); if (mathReply) return mathReply;
    if (text.includes('api') || text.includes('key')) return 'You can manage your API key by clicking the "API Key" button in the top right.';
    return null;
  }
  function add(text, cls, isTyping = false) {
    const d = document.createElement('div');
    d.className = `msg ${cls}`;
    if (isTyping) {
      d.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      d.id = 'typing-msg';
    } else { d.textContent = text; }
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return d;
  }
  function removeTypingIndicator() {
    const typingMsg = document.getElementById('typing-msg');
    if (typingMsg) typingMsg.remove();
  }

  /* ===== MAIN ASK FUNCTION - UPDATED FOR GROQ API ===== */
  async function ask() {
    const text = q.value.trim();
    if (!text) return;
    q.value = '';
    add(text, 'user');
    send.disabled = true;
    q.disabled = true;

    // Show typing indicator for online responses
    let typingIndicator = null;
    if (!offlineReply(text)) typingIndicator = add('', 'ai', true);

    // ===== OFFLINE FIRST =====
    const local = offlineReply(text);
    if (local) {
      setTimeout(() => {
        removeTypingIndicator();
        add(local, 'ai');
        send.disabled = false;
        q.disabled = false;
        q.focus();
      }, 500);
      return;
    }

    // ===== ONLINE (GROQ) =====
    // Check if API key exists
    if (!GROQ_API_KEY) {
      removeTypingIndicator();
      add('To answer this question, I need to use online features. Please add your Groq API key by clicking the "API Key" button in the top right.', 'ai');
      send.disabled = false;
      q.disabled = false;
      q.focus();
      dialog.classList.add('show');
      return;
    }

    try {
      // GROQ API CALL
      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${GROQ_API_KEY}` // Groq uses Bearer token auth
        },
        body: JSON.stringify({
          messages: [
            {
              role: 'system',
              content: 'You are Ramanujan School AI, a helpful assistant for students. Answer questions clearly and concisely.'
            },
            {
              role: 'user',
              content: text
            }
          ],
          model: 'llama3-70b-8192', // You can also try 'llama-3.3-70b-versatile' or 'mixtral-8x7b-32768'[citation:9]
          temperature: 0.7,
          max_tokens: 500
        })
      });
      removeTypingIndicator();
      if (!response.ok) {
        const error = await response.json();
        let errorMsg = '';
        if (error.error?.type === 'invalid_request_error') {
          errorMsg = 'API key error. Please check your key is valid.';
          updateApiStatus();
        } else if (error.error?.code === 'rate_limit_exceeded') {
          errorMsg = 'Rate limit reached. Groq free tier is generous, but please wait a moment.';
        } else {
          errorMsg = `Error: ${error.error?.message || 'Unknown error'}`;
        }
        add(errorMsg, 'ai');
      } else {
        const data = await response.json();
        // Groq response path is different: data.choices[0].message.content
        const reply = data.choices?.[0]?.message?.content || 'I received an empty response. Please try again.';
        add(reply, 'ai');
      }
    } catch (err) {
      removeTypingIndicator();
      console.error('Request failed:', err);
      add('Network error. Please check your connection and try again.', 'ai');
    }
    send.disabled = false;
    q.disabled = false;
    q.focus();
  }

  // Event listeners
  send.onclick = ask;
  q.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      ask();
    }
  });
  window.addEventListener('load', () => { q.focus(); });
</script>
</body>
</html>

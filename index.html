<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ramanujan School AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1220; --card:#161a35; --accent:#6cf2c2; --accent2:#7aa2ff;
      --text:#e7e9ff; --muted:#aab0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:linear-gradient(rgba(15,18,32,.75),rgba(15,18,32,.75)),url('assets/images/bg.png') center/cover no-repeat;color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center}
    .app{width:min(980px,94vw);height:min(620px,90vh);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0)),var(--card);border-radius:22px;box-shadow:0 30px 80px rgba(0,0,0,.45);display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
    header{padding:18px 22px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .logo{width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,.9);display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain}
    header h1{font-size:18px;margin:0}
    header span{color:var(--muted);font-size:13px}
    .chat{padding:18px;overflow:auto}
    .msg{max-width:78%;margin-bottom:14px;padding:12px 14px;border-radius:14px;line-height:1.45}
    .user{margin-left:auto;background:linear-gradient(135deg,#2a3170,#2d3aa6)}
    .ai{background:#202661}
    footer{padding:14px;border-top:1px solid rgba(255,255,255,.08)}
    .input{display:flex;gap:10px;align-items:center;background:#0e1230;padding:10px;border-radius:14px}
    input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:14px}
    button{border:none;cursor:pointer;padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#071515;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    /* API KEY MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center}
    .modal-box{background:#161a35;padding:22px;border-radius:18px;width:min(420px,90vw)}
    .modal-box h3{margin-top:0}
  </style>
</head>
<body>

<!-- API KEY DIALOG -->
<div id="apiModal" class="modal">
  <div class="modal-box">
    <h3>Enter Gemini API Key</h3>
    <input id="apiInput" placeholder="AIzaSy..." style="width:100%;margin:10px 0;padding:10px;border-radius:10px;border:none" />
    <button id="saveKey" style="width:100%">Save Key</button>
    <p class="hint">Key is stored only in this browser (localStorage).</p>
  </div>
</div>

<div class="app">
  <header>
    <div class="logo"><img src="assets/images/logo.png" alt="School Logo"></div>
    <div>
      <h1>Ramanujan School AI</h1>
      <span>Homework help â€¢ Concepts â€¢ Practice</span>
    </div>
  </header>

  <div id="chat" class="chat">
    <div class="msg ai">Hello! Iâ€™m Ramanujan School AI. Ask me any school question ðŸ™‚</div>
  </div>

  <footer>
    <div class="input">
      <input id="q" placeholder="Type your questionâ€¦" />
      <button id="send">Send</button>
    </div>
    <div class="hint">Demo project UI. Google Gemini 1.5 Flash integrated.</div>
  </footer>
</div>

<script>
  // ===== API KEY HANDLING =====
  const modal = document.getElementById('apiModal');
  const apiInput = document.getElementById('apiInput');
  const saveKey = document.getElementById('saveKey');

  let GEMINI_KEY = localStorage.getItem('GEMINI_API_KEY');
  if(!GEMINI_KEY) modal.style.display = 'grid';
  else modal.style.display = 'none';

  saveKey.onclick = () => {
    if(apiInput.value.trim()){
      localStorage.setItem('GEMINI_API_KEY', apiInput.value.trim());
      GEMINI_KEY = apiInput.value.trim();
      modal.style.display = 'none';
    }
  };

  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const send = document.getElementById('send');

  // ===== OFFLINE KNOWLEDGE BASE (UNCHANGED) =====
  const JAGANNATH_KB = `Lord Jagannath is a revered form of Lord Vishnu/Krishna...`;

  function isGreeting(t){return /^(hi|hello|hey|namaste)/i.test(t)}
  function isHowAreYou(t){return /(how are you|how r u)/i.test(t)}
  function isJagannathQuery(t){return /(jagannath|puri|rath yatra|nabakalebara|mahaprasad)/i.test(t)}

  function offlineReply(text){
    if(isGreeting(text)) return "Hello. How may I assist you today?";
    if(isHowAreYou(text)) return "I am functioning well. Thank you for asking.";
    if(isJagannathQuery(text)) return JAGANNATH_KB;
    return null;
  }

  function add(text, cls){
    const d = document.createElement('div');
    d.className = `msg ${cls}`;
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }

  async function ask(){
    const text = q.value.trim();
    if(!text) return;
    q.value = '';
    add(text,'user');
    send.disabled = true;

    const local = offlineReply(text);
    if(local){ add(local,'ai'); send.disabled=false; return; }

    try{
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text}]}]})
      });

      const data = await res.json();
      const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      add(reply || 'No response from AI.','ai');
    }catch(e){
      add('Network error.','ai');
    }
    send.disabled=false;
  }

  send.onclick = ask;
  q.addEventListener('keydown',e=>{if(e.key==='Enter')ask();});
</script>
</body>
</html>

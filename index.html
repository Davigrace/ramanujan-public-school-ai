<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ramanujan School AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== 1. STARTUP SCREEN & ANIMATIONS ===== */
    #startupScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(145deg, #0a0e1f 0%, #13172b 50%, #0f1220 100%);
      color: var(--text);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
    }

    .startup-slide {
      text-align: center;
      max-width: 900px;
      width: 90%;
      padding: 40px;
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }
    .startup-slide.active {
      display: block;
      animation: slideUpFadeIn 0.8s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
    }

    @keyframes slideUpFadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes logoPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* School Logo/Image Slide */
    .school-logo-container {
      margin: 0 auto 40px;
      width: 320px;
      height: 320px;
      border-radius: 24px;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      display: grid;
      place-items: center;
      padding: 20px;
      border: 1px solid rgba(108, 242, 194, 0.2);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: logoPulse 3s ease-in-out infinite;
    }
    .school-logo-container img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
    }

    /* Credits Slide */
    .credits-title {
      font-size: 3.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }
    .credits-subtitle {
      font-size: 1.2rem;
      color: var(--muted);
      margin-bottom: 50px;
      font-weight: 300;
    }
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 60px;
    }
    .team-member {
      background: rgba(255, 255, 255, 0.03);
      padding: 25px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      transition: all 0.3s ease;
    }
    .team-member:hover {
      transform: translateY(-8px);
      background: rgba(108, 242, 194, 0.05);
      border-color: rgba(108, 242, 194, 0.3);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }
    .member-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    .member-role {
      font-size: 0.95rem;
      color: var(--accent);
      font-weight: 500;
      background: rgba(108, 242, 194, 0.1);
      padding: 6px 14px;
      border-radius: 100px;
      display: inline-block;
    }

    /* Start Button */
    .start-button {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #071515;
      font-size: 1.3rem;
      font-weight: 700;
      padding: 20px 50px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(108, 242, 194, 0.3);
    }
    .start-button:hover {
      transform: scale(1.05) translateY(-5px);
      box-shadow: 0 15px 40px rgba(108, 242, 194, 0.4);
    }
    .start-button:active {
      transform: scale(0.98);
    }
    
    /* Skip Button */
    .skip-button {
      position: absolute;
      top: 30px;
      right: 30px;
      background: rgba(108, 242, 194, 0.1);
      border: 1px solid rgba(108, 242, 194, 0.3);
      color: var(--accent);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 2001;
    }
    .skip-button:hover {
      background: rgba(108, 242, 194, 0.2);
      transform: translateY(-2px);
    }

    /* ===== 2. MAIN APP STYLES ===== */
    :root{
      --bg:#0f1220;
      --card:#161a35;
      --accent:#6cf2c2;
      --accent2:#7aa2ff;
      --text:#e7e9ff;
      --muted:#aab0ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        linear-gradient(rgba(15,18,32,.75), rgba(15,18,32,.75)),
        url('assets/images/bg.png') center/cover no-repeat;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      transition: background 0.5s ease;
    }
    .app{
      width:min(980px, 94vw);
      height:min(700px, 90vh);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
                 var(--card);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(0,0,0,.45);
      display:grid;
      grid-template-rows:auto 1fr auto;
      overflow:hidden;
      position:relative;
      animation: appLoad 0.8s ease-out;
    }
    @keyframes appLoad {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    /* Split View Container */
    body.split-mode {
      padding: 20px 10px;
    }
    body.split-mode .app {
      width: 48%;
      margin-right: 1%;
    }
    
    /* ===== FULLSCREEN MODE ===== */
    body.fullscreen-mode {
      padding: 0;
      display: block;
      overflow: hidden;
    }
    body.fullscreen-mode .app {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
      max-width: none;
      max-height: none;
      animation: none;
    }
    
    /* Fullscreen toggle button */
    .fullscreen-toggle-btn {
      background: rgba(122, 162, 255, 0.1);
      border: 1px solid rgba(122, 162, 255, 0.3);
      color: var(--accent2);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .fullscreen-toggle-btn:hover {
      background: rgba(122, 162, 255, 0.2);
      float: left;
      transition: all 0.4s ease;
    }
    
    /* Code Runner Panel */
    .code-runner-panel {
      width: 0;
      opacity: 0;
      background: var(--card);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow: hidden;
      transition: all 0.4s ease;
      display: none;
      flex-direction: column;
      float: left;
      height: min(700px, 90vh);
    }
    
    body.split-mode .code-runner-panel {
      width: 48%;
      opacity: 1;
      display: flex;
    }
    
    .code-runner-header {
      padding: 18px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    
    .code-runner-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text);
    }
    
    .close-runner-btn {
      background: rgba(255, 100, 100, 0.1);
      border: 1px solid rgba(255, 100, 100, 0.3);
      color: #ff7a7a;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .close-runner-btn:hover {
      background: rgba(255, 100, 100, 0.2);
    }
    
    .code-runner-content {
      flex: 1;
      background: white;
      margin: 10px;
      border-radius: 12px;
      overflow: auto;
    }
    
    .code-runner-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Header */
    header{
      padding:18px 22px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .logo{
      width:38px;
      height:38px;
      border-radius:10px;
      background:rgba(255,255,255,.9);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    header h1{
      font-size:18px;
      margin:0;
    }
    header span{
      color:var(--muted);
      font-size:13px;
    }
    
    /* Action buttons */
    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .action-btn{
      background:rgba(108, 242, 194, 0.1);
      border:1px solid rgba(108, 242, 194, 0.3);
      color:var(--accent);
      padding:6px 12px;
      border-radius:8px;
      font-size:12px;
      cursor:pointer;
      transition:all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .action-btn:hover{
      background:rgba(108, 242, 194, 0.2);
    }
    .clear-btn {
      background: rgba(255, 100, 100, 0.1);
      border: 1px solid rgba(255, 100, 100, 0.3);
      color: #ff7a7a;
    }
    .clear-btn:hover {
      background: rgba(255, 100, 100, 0.2);
    }
    
    /* Features Toggle Button */
    .features-toggle {
      background: rgba(122, 162, 255, 0.1);
      border: 1px solid rgba(122, 162, 255, 0.3);
      color: var(--accent2);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .features-toggle:hover {
      background: rgba(122, 162, 255, 0.2);
    }
    
    /* Features Panel */
    .features-panel {
      position: absolute;
      top: 60px;
      right: 20px;
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 12px;
      padding: 15px;
      width: 250px;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .5);
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .features-panel.show {
      display: flex;
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Chat area - Made bigger */
    .chat{
      padding:18px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      height: calc(100% - 10px);
    }
    .msg{
      max-width:78%;
      padding:12px 14px;
      border-radius:14px;
      line-height:1.45;
      word-wrap:break-word;
      animation: messageSlideIn 0.4s ease-out forwards;
    }
    @keyframes messageSlideIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .user{
      margin-left:auto;
      background:linear-gradient(135deg, #2a3170, #2d3aa6);
      align-self: flex-end;
    }
    .ai{
      background:#202661;
      align-self: flex-start;
    }
    
    /* ===== 3. FORMATTED TEXT STYLES ===== */
    .formatted-text {
      line-height: 1.6;
      font-size: 14px;
    }
    
    .formatted-text p {
      margin-bottom: 1em;
    }
    
    .formatted-text ul, .formatted-text ol {
      margin: 0.5em 0 0.5em 1.5em;
      padding: 0;
    }
    
    .formatted-text li {
      margin-bottom: 0.5em;
    }
    
    .formatted-text strong, .formatted-text b {
      color: var(--accent);
      font-weight: 600;
    }
    
    .formatted-text em, .formatted-text i {
      font-style: italic;
    }
    
    .formatted-text h3, .formatted-text h4 {
      margin: 1em 0 0.5em 0;
      color: var(--accent);
    }
    
    
    /* Code Block Styling */
    .code-container {
      background: #1e1e1e;
      border-radius: 12px;
      margin: 15px 0;
      overflow: hidden;
      border: 1px solid rgba(108, 242, 194, 0.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .code-header {
      background: linear-gradient(135deg, rgba(108, 242, 194, 0.12), rgba(122, 162, 255, 0.08));
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(108, 242, 194, 0.15);
      backdrop-filter: blur(10px);
    }
    
    .code-language {
      font-size: 12px;
      color: var(--accent);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .code-language::before {
      content: "‚ö°";
      font-size: 14px;
    }
    
    .code-actions {
      display: flex;
      gap: 8px;
    }
    
    .code-action-btn {
      background: rgba(108, 242, 194, 0.15);
      border: 1px solid rgba(108, 242, 194, 0.25);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .code-action-btn:hover {
      background: rgba(108, 242, 194, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(108, 242, 194, 0.2);
    }
    
    .code-action-btn:active {
      transform: translateY(0);
    }
    
    .run-code-btn {
      background: linear-gradient(135deg, #6cf2c2, #7aa2ff);
      color: #0a0e1f;
      font-weight: 700;
      border: none;
      box-shadow: 0 2px 8px rgba(108, 242, 194, 0.3);
    }
    
    .run-code-btn:hover {
      box-shadow: 0 6px 16px rgba(108, 242, 194, 0.5);
      transform: translateY(-3px);
    }
    
    .code-block {
      padding: 16px;
      overflow-x: auto;
      font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.7;
      color: #d4d4d4;
      background: #1e1e1e;
      tab-size: 2;
    }
    
    .code-block code {
      color: inherit;
      background: transparent !important;
      padding: 0 !important;
      white-space: pre;
    }
    
    /* Syntax Highlighting Colors */
    .code-block .keyword { color: #569cd6; font-weight: 600; }
    .code-block .string { color: #ce9178; }
    .code-block .comment { color: #6a9955; font-style: italic; }
    .code-block .number { color: #b5cea8; }
    .code-block .function { color: #dcdcaa; }
    .code-block .tag { color: #4ec9b0; }
    .code-block .attribute { color: #9cdcfe; }
    .code-block .value { color: #ce9178; }
    .code-block .punctuation { color: #d4d4d4; }
    .code-block .operator { color: #d4d4d4; }
    .code-block .variable { color: #9cdcfe; }
    .code-block .class-name { color: #4ec9b0; }
    .code-block .property { color: #9cdcfe; }
    .code-block .selector { color: #d7ba7d; }
    .code-block .important { color: #f44747; font-weight: 600; }
    
    .code-block::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    
    .code-block::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    
    .code-block::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgba(108, 242, 194, 0.4), rgba(122, 162, 255, 0.4));
      border-radius: 4px;
    }
    
    .code-block::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(108, 242, 194, 0.6), rgba(122, 162, 255, 0.6));
    }
    .formatted-text h3 {
      font-size: 1.2em;
      font-weight: 700;
    }
    
    .formatted-text h4 {
      font-size: 1.1em;
      font-weight: 600;
    }
    
    .formatted-text code {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }
    
    .formatted-text blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 1em;
      margin: 1em 0;
      color: var(--muted);
      font-style: italic;
    }
    
    .formatted-text .step {
      margin: 1em 0;
      padding-left: 1.5em;
      position: relative;
    }
    
    .formatted-text .step:before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: var(--accent);
    }
    
    /* Footer */
    footer{
      padding:14px;
      border-top:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .input{
      display:flex;
      gap:10px;
      align-items:center;
      background:#0e1230;
      padding:10px;
      border-radius:14px;
    }
    input{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      transition: box-shadow 0.2s ease;
    }
    input:focus {
      box-shadow: 0 0 0 2px rgba(108, 242, 194, 0.4);
    }
    button{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071515;
      font-weight:700;
      transition:all 0.2s ease;
    }
    button:hover{
      opacity:0.9;
      transform: translateY(-1px);
    }
    button:active{
      transform: scale(0.96);
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform: none !important;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    /* Mode indicators in footer */
    .mode-indicators {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .mode-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .mode-indicator.online {
      background: rgba(76, 175, 80, 0.1);
      border-color: rgba(76, 175, 80, 0.3);
    }
    .mode-indicator.offline {
      background: rgba(255, 100, 100, 0.1);
      border-color: rgba(255, 100, 100, 0.3);
    }
    .mode-indicator.hybrid {
      background: rgba(255, 193, 7, 0.1);
      border-color: rgba(255, 193, 7, 0.3);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-dot.online {
      background-color: #4CAF50;
      box-shadow: 0 0 10px #4CAF50;
    }
    .status-dot.offline {
      background-color: #ff5252;
      box-shadow: 0 0 10px #ff5252;
    }
    .status-dot.hybrid {
      background-color: #ffc107;
      box-shadow: 0 0 10px #ffc107;
    }
    
    /* Dialogs */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      display: none;
    }
    .dialog-overlay.show {
      display: block;
    }
    
    .api-dialog, .credits-dialog, .history-dialog, .persona-dialog, .voice-dialog, .upload-dialog,
    .dev-dialog, .background-dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      padding: 25px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .15);
      box-shadow: 0 15px 50px rgba(0, 0, 0, .6);
      width: 450px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 101;
      display: none;
      animation: dialogFadeIn 0.3s ease;
    }
    @keyframes dialogFadeIn {
      from { opacity: 0; transform: translateY(-10px) translate(-50%, -50%); }
      to { opacity: 1; transform: translateY(0) translate(-50%, -50%); }
    }
    .api-dialog.show, .credits-dialog.show, .history-dialog.show, 
    .persona-dialog.show, .voice-dialog.show, .upload-dialog.show,
    .dev-dialog.show, .background-dialog.show {
      display: block;
    }
    
    /* Dialog specific */
    .dialog-content {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .api-dialog h3, .credits-dialog h3, .history-dialog h3, 
    .persona-dialog h3, .voice-dialog h3, .upload-dialog h3,
    .dev-dialog h3, .background-dialog h3 {
      margin: 0 0 20px 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--accent);
    }
    
    .api-dialog h3:before {
      content: "üîë";
      font-size: 18px;
    }
    .history-dialog h3:before {
      content: "üìú";
      font-size: 18px;
    }
    .persona-dialog h3:before {
      content: "üé≠";
      font-size: 18px;
    }
    .voice-dialog h3:before {
      content: "üîä";
      font-size: 18px;
    }
    .upload-dialog h3:before {
      content: "üìÅ";
      font-size: 18px;
    }
    .dev-dialog h3:before {
      content: "üíª";
      font-size: 18px;
    }
    .background-dialog h3:before {
      content: "üé®";
      font-size: 18px;
    }
    
    .api-input-container {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .api-input, .persona-input {
      flex: 1;
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      resize: vertical;
    }
    .persona-input {
      width: 100%;
      min-height: 120px;
    }
    .api-input:focus, .persona-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Dev mode styles */
    .dev-editor-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .code-tabs {
      display: flex;
      gap: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .code-tab {
      padding: 8px 15px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .code-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .code-editor {
      height: 250px;
      background: #1a1f3f;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: var(--text);
      resize: none;
      white-space: pre;
      overflow: auto;
    }
    .code-output {
      height: 200px;
      background: #0a0e1f;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .output-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }
    .dev-controls {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    /* Background selector styles */
    .background-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .background-option {
      cursor: pointer;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .background-option:hover {
      transform: translateY(-3px);
    }
    .background-option.selected {
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(108, 242, 194, 0.3);
    }
    .bg-preview {
      height: 100px;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      text-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .bg-name {
      padding: 10px;
      background: rgba(0, 0, 0, 0.7);
      text-align: center;
      font-size: 12px;
    }
    
    /* Voice selection */
    .voice-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .voice-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .voice-option:hover {
      background: rgba(108, 242, 194, 0.05);
      border-color: rgba(108, 242, 194, 0.3);
    }
    .voice-option.selected {
      background: rgba(108, 242, 194, 0.1);
      border-color: var(--accent);
    }
    .voice-option input[type="radio"] {
      margin: 0;
    }
    .voice-label {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .voice-name {
      font-weight: 600;
      color: var(--text);
    }
    .voice-type {
      font-size: 11px;
      color: var(--muted);
    }
    .voice-preview {
      background: rgba(108, 242, 194, 0.1);
      border: none;
      color: var(--accent);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .voice-preview:hover {
      background: rgba(108, 242, 194, 0.2);
    }
    
    /* Upload area */
    .upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(108, 242, 194, 0.05);
    }
    .upload-area.dragover {
      border-color: var(--accent);
      background: rgba(108, 242, 194, 0.1);
    }
    .upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: var(--accent);
    }
    .upload-text {
      color: var(--text);
      margin-bottom: 5px;
    }
    .upload-subtext {
      color: var(--muted);
      font-size: 12px;
    }
    .uploaded-files {
      margin-top: 20px;
      max-height: 150px;
      overflow-y: auto;
    }
    .uploaded-file {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .file-name {
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-size {
      font-size: 11px;
      color: var(--muted);
    }
    .remove-file {
      background: none;
      border: none;
      color: #ff7a7a;
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
    }
    
    /* Audio controls */
    .audio-controls {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 5px;
    }
    .audio-btn {
      background: rgba(122, 162, 255, 0.1);
      border: 1px solid rgba(122, 162, 255, 0.3);
      color: var(--accent2);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .audio-btn:hover {
      background: rgba(122, 162, 255, 0.2);
    }
    .audio-btn.active {
      background: rgba(108, 242, 194, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* Microphone button */
    .mic-btn {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #ffc107;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
    }
    .mic-btn:hover {
      background: rgba(255, 193, 7, 0.2);
    }
    .mic-btn.listening {
      background: rgba(255, 50, 50, 0.2);
      border-color: #ff3232;
      color: #ff3232;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Status indicators */
    .api-status {
      font-size: 12px;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
      background: rgba(255, 255, 255, .05);
    }
    .api-status.valid {
      color: var(--accent);
      background: rgba(108, 242, 194, 0.1);
    }
    .api-status.invalid {
      color: #ff7a7a;
      background: rgba(255, 122, 122, 0.1);
    }
    .api-actions, .dialog-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .api-actions button, .dialog-actions button {
      padding: 8px 16px;
      font-size: 12px;
    }
    .api-actions .secondary, .dialog-actions .secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--text);
    }
    .api-actions .secondary:hover, .dialog-actions .secondary:hover {
      background: rgba(255, 255, 255, .15);
    }
    .api-help {
      font-size: 11px;
      color: var(--muted);
      margin-top: 12px;
      line-height: 1.4;
    }
    .api-help a {
      color: var(--accent);
      text-decoration: none;
    }
    .api-help a:hover {
      text-decoration: underline;
    }
    
    /* Close buttons */
    .close-dialog {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .close-dialog:hover {
      background: rgba(255, 255, 255, .1);
      color: var(--text);
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
    }
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }
    
    /* History items */
    .history-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.07);
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .history-role {
      font-weight: 600;
      color: var(--accent);
    }
    .history-time {
      font-size: 11px;
      color: var(--muted);
    }
    .history-content {
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    /* Credits button */
    .credits-btn{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      color:var(--muted);
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .credits-btn:hover{
      background:rgba(255,255,255,0.1);
      color:var(--text);
    }
    
    /* ===== AUDIO CONTROL BUTTONS ===== */
    .audio-controls-container {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .speak-btn, .stop-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      border: 1px solid;
    }
    
    .speak-btn {
      background: rgba(108, 242, 194, 0.1);
      border-color: rgba(108, 242, 194, 0.3);
      color: var(--accent);
    }
    
    .speak-btn:hover:not(:disabled) {
      background: rgba(108, 242, 194, 0.2);
    }
    
    .stop-btn {
      background: rgba(255, 100, 100, 0.1);
      border-color: rgba(255, 100, 100, 0.3);
      color: #ff7a7a;
    }
    
    .stop-btn:hover:not(:disabled) {
      background: rgba(255, 100, 100, 0.2);
    }
    
    .speak-btn:disabled, .stop-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .voice-playing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
      color: var(--accent);
      font-size: 12px;
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <!-- ===== STARTUP SCREENS ===== -->
  <div id="startupScreen">
    <button class="skip-button" onclick="startChatApp()">Skip ‚Üí</button>
    <!-- Slide 1: School Information -->
    <div class="startup-slide active" id="slideSchool">
      <div class="school-logo-container">
        <img src="assets/images/images.png" alt="Ramanujan Public School" />
      </div>
      <h1 style="font-size: 2.8rem; margin-bottom: 15px;">Ramanujan Public School</h1>
      <p style="font-size: 1.1rem; color: var(--muted); line-height: 1.7; max-width: 600px; margin: 0 auto 30px;">
        Sanapur Urf Pepalgaon (Oppt. IIIT, Jhalwa)<br>
        Allahabad-211012<br>
        Phone: +91-7752922226<br>
        E-mail: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9ae8eae9f0f2fbf6edfbb4fbf6f6dafdf7fbf3f6b4f9f5f7">[email&#160;protected]</a>
      </p>
      <p style="font-size: 1.8rem; font-weight: 600; margin-top: 40px; color: var(--accent);">
        Presents
      </p>
      <h2 style="font-size: 3rem; font-weight: 700; background: linear-gradient(90deg, #6cf2c2, #7aa2ff); -webkit-background-clip: text; background-clip: text; color: transparent; margin: 10px 0 40px 0;">
        School AI Assistant
      </h2>
      <button class="start-button" onclick="showNextSlide()">
        Meet the Team <span style="font-size: 1.2rem;">‚Üí</span>
      </button>
    </div>

    <!-- Slide 2: Team Credits -->
    <div class="startup-slide" id="slideTeam">
      <div class="credits-title">Project Credits</div>
      <div class="credits-subtitle">Built with dedication by the students of Class IX-B</div>

      <div class="team-grid">
        <div class="team-member">
          <div class="member-name">Priyansh</div>
          <div class="member-role">Developer & Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Vansh</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Shreyash</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Shreya</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Anshika</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Ananya</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Ankit</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Kashfa</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Utkarshini</div>
          <div class="member-role">Presenter</div>
        </div>
      </div>

      <button class="start-button" onclick="startChatApp()">
        Start Chatting <span style="font-size: 1.2rem;">üöÄ</span>
      </button>
    </div>
  </div>

  <!-- ===== DIALOG OVERLAY ===== -->
  <div class="dialog-overlay" id="dialogOverlay"></div>

  <!-- ===== MAIN CHAT APP (HIDDEN INITIALLY) ===== -->
  <div class="app" id="mainApp" style="display: none;">
    <!-- Header with simplified buttons -->
    <header>
      <div class="logo"><img src="assets/images/logo.png" alt="School Logo"></div>
      <div>
        <h1>Ramanujan School AI</h1>
        <span>Homework help ‚Ä¢ Concepts ‚Ä¢ Practice</span>
      </div>
      <div class="header-actions">
        <button class="action-btn clear-btn" id="clearChatBtn">üóëÔ∏è Clear</button>
        <button class="fullscreen-toggle-btn" id="fullscreenToggleBtn" onclick="toggleFullscreen()">
          ‚õ∂ Full Screen
        </button>
        <button class="features-toggle" id="featuresToggleBtn">
          ‚öôÔ∏è Features
        </button>
      </div>
      
      <!-- Features Panel (hidden by default) -->
      <div class="features-panel" id="featuresPanel">
        <button class="action-btn" id="openApiDialog">üîë API Key</button>
        <button class="action-btn" id="openModelDialog">ü§ñ AI Model</button>
        <button class="action-btn" id="openHistoryBtn">üìú History</button>
        <button class="action-btn" id="openPersonaBtn">üé≠ Persona</button>
        <button class="action-btn" id="openVoiceBtn">üîä Voice</button>
        <button class="action-btn" id="openUploadBtn">üìÅ Upload</button>
        <button class="action-btn" id="openDevModeBtn">üíª Dev Mode</button>
        <button class="action-btn" id="openBackgroundBtn">üé® Background</button>
        <button class="action-btn" id="openCreditsDialog">‚≠ê Credits</button>
      </div>
    </header>

    <!-- Chat area - Made bigger -->
    <div id="chat" class="chat">
      <div class="msg ai">
        <div class="formatted-text">
          <p>Hello! I am Ramanujan Public School AI assistant. How can I help you today?</p>
          <div class="audio-controls-container">
            <button class="speak-btn">üîä Speak</button>
            <button class="stop-btn" disabled>‚èπÔ∏è Stop</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer with input and mode indicators -->
    <footer>
      <div class="input">
        <input id="q" placeholder="Type your question or click üé§ to speak..." />
        <button class="mic-btn" id="micBtn">üé§</button>
        <button id="send">Send</button>
      </div>
      <div class="hint">
        <div class="mode-indicators">
          <div class="mode-indicator online" id="onlineIndicator">
            <div class="status-dot online"></div>
            <span>Online</span>
          </div>
          <div class="mode-indicator offline" id="offlineIndicator">
            <div class="status-dot offline"></div>
            <span>Offline</span>
          </div>
          <div class="mode-indicator hybrid" id="hybridIndicator">
            <div class="status-dot hybrid"></div>
            <span>Hybrid</span>
          </div>
        </div>
        <div>
          <span id="currentModeText" style="font-size: 11px; color: var(--muted);">Current: Online Only</span>
        </div>
      </div>
    </footer>
  </div>

  <!-- ===== ALL DIALOGS ===== -->
  
  <!-- API Key Dialog -->
  <div id="apiDialog" class="api-dialog">
    <button class="close-dialog" id="closeApiDialog">√ó</button>
    <h3>Groq API Key</h3>
    <div class="api-input-container">
      <input type="password" id="apiInput" class="api-input" placeholder="Enter your API key..." />
      <button id="saveKey" class="small">Save</button>
    </div>
    <div id="apiStatus" class="api-status">
      Status: No API key saved
    </div>
    <div class="api-actions">
      <button id="clearKey" class="secondary">Clear Key</button>
      <button id="testKey" class="secondary">Test Key</button>
    </div>
    <div class="api-help">
      Get your free API key from
      <a href="https://console.groq.com" target="_blank">Groq Console</a>.
      Keys are stored locally in your browser only.
    </div>
  </div>

  <!-- Model Selector Dialog -->
  <div id="modelDialog" class="api-dialog">
    <button class="close-dialog" id="closeModelDialog">√ó</button>
    <h3>ü§ñ Select AI Model</h3>
    <div class="dialog-content" style="max-height: 400px; overflow-y: auto;">
      <p style="color: var(--muted); font-size: 13px; margin-bottom: 15px;">
        Choose the AI model for your conversations. Different models offer different speeds and capabilities.
      </p>
      
      <div class="model-grid" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Llama 3.3 (Latest & Best) -->
        <div class="model-category" style="margin-top: 10px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">ü¶ô Llama 3.3 (Latest)</h4>
          
          <button class="model-option" data-model="llama-3.3-70b-versatile" style="width: 100%; text-align: left; background: rgba(108, 242, 194, 0.1); border: 1px solid rgba(108, 242, 194, 0.3); color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s ease;">
            <div style="font-weight: 600; font-size: 14px;">Llama 3.3 70B Versatile üß†</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Latest ‚Ä¢ Best quality ‚Ä¢ Advanced reasoning ‚Ä¢ Recommended</div>
          </button>
        </div>
        
        <!-- Llama 3.1 (Stable & Recommended) -->
        <div class="model-category" style="margin-top: 10px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">ü¶ô Llama 3.1 (Most Stable)</h4>
          
          <button class="model-option" data-model="llama-3.1-8b-instant" style="width: 100%; text-align: left; background: rgba(108, 242, 194, 0.1); border: 1px solid rgba(108, 242, 194, 0.3); color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s ease;">
            <div style="font-weight: 600; font-size: 14px;">Llama 3.1 8B Instant ‚ö°</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Fast ‚Ä¢ Reliable ‚Ä¢ Default model</div>
          </button>
          
          <button class="model-option" data-model="llama-3.1-70b-versatile" style="width: 100%; text-align: left; background: rgba(108, 242, 194, 0.1); border: 1px solid rgba(108, 242, 194, 0.3); color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s ease;">
            <div style="font-weight: 600; font-size: 14px;">Llama 3.1 70B Versatile üß†</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">High quality ‚Ä¢ Better reasoning ‚Ä¢ Complex tasks</div>
          </button>
        </div>
        
        <!-- Other Models -->
        <div class="model-category" style="margin-top: 10px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">üåü Other Models</h4>
          
          <button class="model-option" data-model="mixtral-8x7b-32768" style="width: 100%; text-align: left; background: rgba(255, 182, 193, 0.1); border: 1px solid rgba(255, 182, 193, 0.3); color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s ease;">
            <div style="font-weight: 600; font-size: 14px;">Mixtral 8x7B</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Large context ‚Ä¢ 32K tokens ‚Ä¢ Multilingual</div>
          </button>
          
          <button class="model-option" data-model="gemma2-9b-it" style="width: 100%; text-align: left; background: rgba(255, 182, 193, 0.1); border: 1px solid rgba(255, 182, 193, 0.3); color: var(--text); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s ease;">
            <div style="font-weight: 600; font-size: 14px;">Gemma 2 9B</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Google ‚Ä¢ Improved performance ‚Ä¢ Versatile</div>
          </button>
        </div>
      </div>


      
      <div style="margin-top: 15px; padding: 12px; background: rgba(108, 242, 194, 0.05); border-radius: 8px; border: 1px solid rgba(108, 242, 194, 0.2);">
        <div style="font-size: 12px; color: var(--muted);">
          <strong style="color: var(--accent);">Current Model:</strong> <span id="currentModelDisplay">Llama 3.1 8B Instant</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Credits Dialog -->
  <div id="creditsDialog" class="credits-dialog">
    <button class="close-dialog" id="closeCreditsDialog">√ó</button>
    <h3>Project Credits</h3>
    <div class="credits-content">
      <p>This AI Assistant was developed with the assistance of <strong>multiple AI systems</strong>, which provided coding guidance and implementation support.</p>
      
      <p>Developed, compiled, and debugged by <strong>Priyansh Sinha, Class IX-B</strong>.</p>
      
      <p>The AI capabilities are powered by <strong>Groq Cloud API</strong> through the Groq Console, providing fast and efficient language model processing.</p>
      
      <p>All code was written by students of <strong>Class IX-B, Ramanujan Public School, Prayagraj, Jhalwa</strong> as an educational project.</p>
      
      <p><strong>Team Members:</strong> Priyansh (Developer & Presenter), Vansh, Shreyash, Shreya, Anshika, Ananya, Ankit, Kashfa, Utkarshini (All Presenters)</p>
    </div>
    <button class="credits-close" id="closeCreditsBtn">Close</button>
  </div>

  <!-- History Dialog -->
  <div id="historyDialog" class="history-dialog">
    <button class="close-dialog" id="closeHistoryDialog">√ó</button>
    <h3>Chat History</h3>
    <div id="historyContent" class="dialog-content">
      <!-- History items will be loaded here -->
    </div>
    <div class="dialog-actions">
      <button id="clearHistoryBtn" class="secondary">Clear History</button>
      <button id="closeHistoryBtn" class="credits-close">Close</button>
    </div>
  </div>

  <!-- Persona Dialog -->
  <div id="personaDialog" class="persona-dialog">
    <button class="close-dialog" id="closePersonaDialog">√ó</button>
    <h3>AI Persona Settings</h3>
    <div class="credits-content">
      <p>How should the AI respond?</p>
      <textarea id="personaInput" class="persona-input" placeholder="Example: You are a friendly math tutor. Explain concepts simply with examples. Use bullet points for clarity. Keep answers concise."></textarea>
      <small style="color: var(--muted); display: block; margin-top: 5px;">These instructions will be added to every AI request.</small>
    </div>
    <div class="dialog-actions">
      <button id="clearPersonaBtn" class="secondary">Clear</button>
      <button id="savePersonaBtn" class="credits-close">Save Persona</button>
    </div>
  </div>

  <!-- Voice Settings Dialog -->
  <div id="voiceDialog" class="voice-dialog">
    <button class="close-dialog" id="closeVoiceDialog">√ó</button>
    <h3>Voice Settings</h3>
    <div class="credits-content">
      <p>Select a voice for text-to-speech output:</p>
      <div class="voice-options" id="voiceOptions">
        <!-- Voice options will be added here -->
      </div>
      <div style="margin-top: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="autoSpeakToggle">
          <span>Automatically speak AI responses</span>
        </label>
        <small style="color: var(--muted); display: block; margin-top: 5px;">When enabled, AI responses will be read aloud automatically.</small>
      </div>
    </div>
    <button class="credits-close" id="closeVoiceBtn">Close</button>
  </div>

  <!-- Upload Dialog -->
  <div id="uploadDialog" class="upload-dialog">
    <button class="close-dialog" id="closeUploadDialog">√ó</button>
    <h3>File Upload</h3>
    <div class="credits-content">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">Drop files here or click to browse</div>
        <div class="upload-subtext">Supported: .txt files only (Max 2MB)</div>
      </div>
      <input type="file" id="fileInput" accept=".txt" style="display: none;">
      
      <div class="uploaded-files" id="uploadedFiles">
        <!-- Uploaded files will be listed here -->
      </div>
      
      <div style="margin-top: 20px;">
        <small style="color: var(--muted);">
          Uploaded text files will be extracted and can be referenced in conversations.
          Files are stored in your browser's local storage.
        </small>
      </div>
    </div>
    <div class="dialog-actions">
      <button id="clearFilesBtn" class="secondary">Clear All Files</button>
      <button id="closeUploadBtn" class="credits-close">Close</button>
    </div>
  </div>

  <!-- Development Mode Dialog -->
  <div id="devDialog" class="dev-dialog">
    <button class="close-dialog" id="closeDevDialog">√ó</button>
    <h3>App Development Mode</h3>
    <div class="credits-content">
      <p>Write HTML, CSS, and JavaScript code to create web apps. Preview them in real-time!</p>
      
      <div class="dev-editor-container">
        <div class="code-tabs">
          <button class="code-tab active" data-tab="html">HTML</button>
          <button class="code-tab" data-tab="css">CSS</button>
          <button class="code-tab" data-tab="js">JavaScript</button>
        </div>
        
        <textarea id="htmlEditor" class="code-editor active">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;My App&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Hello, World!&lt;/h1&gt;
  &lt;p&gt;Edit this code to create your own web app.&lt;/p&gt;
  &lt;button onclick="showMessage()"&gt;Click Me&lt;/button&gt;
  &lt;div id="output"&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</textarea>
        
        <textarea id="cssEditor" class="code-editor" style="display: none;">body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 50px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  min-height: 100vh;
  margin: 0;
}

h1 {
  font-size: 3em;
  margin-bottom: 20px;
}

p {
  font-size: 1.2em;
  margin-bottom: 30px;
}

button {
  padding: 12px 30px;
  font-size: 1.1em;
  background: white;
  color: #667eea;
  border: none;
  border-radius: 30px;
  cursor: pointer;
  transition: transform 0.3s;
}

button:hover {
  transform: scale(1.05);
}

#output {
  margin-top: 30px;
  font-size: 1.3em;
  font-weight: bold;
}</textarea>
        
        <textarea id="jsEditor" class="code-editor" style="display: none;">function showMessage() {
  const output = document.getElementById('output');
  const messages = [
    "Great job! üéâ",
    "Code executed successfully! ‚úÖ",
    "Welcome to App Development Mode! üíª",
    "You're creating amazing apps! ‚ú®",
    "Keep coding! üë®‚Äçüíª"
  ];
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  output.innerHTML = randomMessage;
  
  // Add some animation
  output.style.opacity = '0';
  output.style.transform = 'translateY(20px)';
  
  setTimeout(() => {
    output.style.transition = 'all 0.5s ease';
    output.style.opacity = '1';
    output.style.transform = 'translateY(0)';
  }, 10);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  console.log('App loaded successfully!');
});</textarea>
      </div>
      
      <div class="code-output">
        <iframe id="codeOutputFrame" class="output-frame"></iframe>
      </div>
    </div>
    <div class="dev-controls">
      <button id="runCodeBtn" class="secondary">‚ñ∂ Run Code</button>
      <button id="resetCodeBtn" class="secondary">üîÑ Reset</button>
      <button id="closeDevBtn" class="credits-close">Close</button>
    </div>
  </div>

  <!-- Background Dialog -->
  <div id="backgroundDialog" class="background-dialog">
    <button class="close-dialog" id="closeBackgroundDialog">√ó</button>
    <h3>Background Settings</h3>
    <div class="credits-content">
      <p>Choose a background for the chat interface:</p>
      
      <div class="background-options" id="backgroundOptions">
        <!-- Background options will be added here -->
      </div>
      
      <div style="margin-top: 20px;">
        <small style="color: var(--muted);">
          Background changes apply to the main chat window only. 
          Changes are saved automatically.
        </small>
      </div>
    </div>
    <button class="credits-close" id="closeBackgroundBtn">Close</button>
  </div>


  <!-- Code Runner Panel -->
  <div class="code-runner-panel" id="codeRunnerPanel">
    <div class="code-runner-header">
      <h3>üöÄ Code Output</h3>
      <button class="close-runner-btn" onclick="closeCodeRunner()">‚úï Close</button>
    </div>
    <div class="code-runner-content" id="codeRunnerContent">
      <iframe id="codeRunnerFrame"></iframe>
    </div>
  </div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
  /* ===== STARTUP SCREEN LOGIC ===== */
  let currentSlide = 0;
  const slides = document.querySelectorAll('.startup-slide');

  function showNextSlide() {
    slides[currentSlide].classList.remove('active');
    currentSlide++;
    if (currentSlide < slides.length) {
      slides[currentSlide].classList.add('active');
    } else {
      startChatApp();
    }
  }

  function startChatApp() {
    const startupScreen = document.getElementById('startupScreen');
    startupScreen.style.opacity = '0';
    startupScreen.style.transform = 'scale(1.05)';
    startupScreen.style.transition = 'opacity 0.6s ease, transform 0.6s ease';

    setTimeout(() => {
      startupScreen.style.display = 'none';
      document.getElementById('mainApp').style.display = 'grid';
      document.getElementById('q').focus();
      initEventListeners();
      initVoiceSettings();
      updateModeIndicators();
      initBackgroundSettings();
      
      // Initialize audio buttons for initial message
      initAudioButtons();
    }, 600);
  }

  /* ===== FULLSCREEN MODE TOGGLE ===== */
  function toggleFullscreen() {
    const body = document.body;
    const btn = document.getElementById('fullscreenToggleBtn');
    
    if (body.classList.contains('fullscreen-mode')) {
      // Exit fullscreen
      body.classList.remove('fullscreen-mode');
      btn.innerHTML = '‚õ∂ Full Screen';
    } else {
      // Enter fullscreen
      body.classList.add('fullscreen-mode');
      btn.innerHTML = '‚õ∂ Exit Full Screen';
    }
  }


  /* ===== TEXT FORMATTING FUNCTION ===== */
  function formatTextForDisplay(text) {
    if (/<[a-z][\s\S]*>/i.test(text)) {
      return text;
    }
    
    let formattedText = text;
    
    // Replace markdown-style formatting
    formattedText = formattedText.replace(/^### (.*$)/gim, '<h4>$1</h4>');
    formattedText = formattedText.replace(/^## (.*$)/gim, '<h3>$1</h3>');
    formattedText = formattedText.replace(/^# (.*$)/gim, '<h3>$1</h3>');
    
    formattedText = formattedText.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    formattedText = formattedText.replace(/^(\d+)\.\s+(.*$)/gim, '<li><strong>$1.</strong> $2</li>');
    formattedText = formattedText.replace(/^[\*\-\‚Ä¢]\s+(.*$)/gim, '<li>$1</li>');
    
    if (formattedText.includes('<li>')) {
      if (formattedText.match(/^<li><strong>\d+\./)) {
        formattedText = formattedText.replace(/<li>/g, '<li>');
        formattedText = '<ol>' + formattedText + '</ol>';
      } else {
        formattedText = '<ul>' + formattedText + '</ul>';
      }
    }
    
    formattedText = formattedText.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    let paragraphs = formattedText.split(/\n\s*\n/);
    
    paragraphs = paragraphs.map(para => {
      para = para.trim();
      if (!para) return '';
      
      if (para.startsWith('<')) {
        return para;
      }
      
      if (para.length < 100 && (para.includes('<h') || para.includes('<li>'))) {
        return para;
      }
      
      return '<p>' + para + '</p>';
    });
    
    formattedText = paragraphs.filter(p => p).join('');
    formattedText = formattedText.replace(/\n/g, '<br>');
    
    return formattedText;
  }

  /* ===== MAIN APPLICATION ===== */
  
  // Conversation memory system
  class ConversationMemory {
    constructor(maxMessages = 20) {
      this.maxMessages = maxMessages;
      this.messages = [];
      this.loadFromStorage();
    }
    
    addMessage(role, content) {
      this.messages.push({ role, content, timestamp: Date.now() });
      this.trimMemory();
      this.saveToStorage();
    }
    
    getContextMessages() {
      return this.messages.slice(-this.maxMessages);
    }
    
    getFullHistory() {
      return this.messages;
    }
    
    clear() {
      this.messages = [];
      localStorage.removeItem('chat_memory');
    }
    
    trimMemory() {
      if (this.messages.length > this.maxMessages) {
        this.messages = this.messages.slice(-this.maxMessages);
      }
    }
    
    saveToStorage() {
      try {
        localStorage.setItem('chat_memory', JSON.stringify(this.messages));
      } catch (e) {
        console.warn('Could not save chat memory:', e);
      }
    }
    
    loadFromStorage() {
      try {
        const saved = localStorage.getItem('chat_memory');
        if (saved) {
          this.messages = JSON.parse(saved);
          this.trimMemory();
        }
      } catch (e) {
        console.warn('Could not load chat memory:', e);
      }
    }
  }

  // File storage system
  class FileStorage {
    constructor() {
      this.files = [];
      this.loadFromStorage();
    }
    
    addFile(name, content, size) {
      const file = {
        id: Date.now().toString(),
        name,
        content,
        size,
        uploaded: Date.now()
      };
      this.files.push(file);
      this.saveToStorage();
      return file;
    }
    
    removeFile(id) {
      this.files = this.files.filter(file => file.id !== id);
      this.saveToStorage();
    }
    
    clearAll() {
      this.files = [];
      localStorage.removeItem('uploaded_files');
    }
    
    getFiles() {
      return this.files;
    }
    
    getFileContent(filename) {
      const file = this.files.find(f => f.name === filename);
      return file ? file.content : null;
    }
    
    saveToStorage() {
      try {
        localStorage.setItem('uploaded_files', JSON.stringify(this.files));
      } catch (e) {
        console.warn('Could not save files:', e);
      }
    }
    
    loadFromStorage() {
      try {
        const saved = localStorage.getItem('uploaded_files');
        if (saved) {
          this.files = JSON.parse(saved);
        }
      } catch (e) {
        console.warn('Could not load files:', e);
      }
    }
  }

  // Initialize systems
  const conversationMemory = new ConversationMemory(20);
  const fileStorage = new FileStorage();
  
  // Global variables
  let GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
  let OFFLINE_MODE_ENABLED = localStorage.getItem('OFFLINE_MODE_ENABLED') !== 'false';
  let selectedVoice = localStorage.getItem('selected_voice') || 'female';
  let autoSpeak = localStorage.getItem('auto_speak') === 'true';
  let currentPersona = localStorage.getItem('AI_PERSONA') || '';
  let currentBackground = localStorage.getItem('background_mode') || 'default';
  
  // Speech synthesis
  let speechSynthesis = window.speechSynthesis;
  let voices = [];
  let currentUtterance = null;
  let isSpeaking = false;
  let currentSpeakingMessage = null;
  
  // Background presets
  const BACKGROUND_PRESETS = [
    {
      id: 'default',
      name: 'Default Space',
      preview: 'linear-gradient(145deg, #0a0e1f 0%, #13172b 50%, #0f1220 100%)'
    },
    {
      id: 'nature',
      name: 'Nature Green',
      preview: 'linear-gradient(135deg, #1a2f3b 0%, #2d5a3d 50%, #1a2f3b 100%)'
    },
    {
      id: 'sunset',
      name: 'Sunset Orange',
      preview: 'linear-gradient(135deg, #2c3e50 0%, #e74c3c 50%, #f39c12 100%)'
    },
    {
      id: 'ocean',
      name: 'Ocean Blue',
      preview: 'linear-gradient(135deg, #0c2461 0%, #1e3799 50%, #4a69bd 100%)'
    },
    {
      id: 'none',
      name: 'No Background',
      preview: '#0f1220'
    }
  ];

  // DOM Elements
  const dialogOverlay = document.getElementById('dialogOverlay');
  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const send = document.getElementById('send');
  const micBtn = document.getElementById('micBtn');
  const featuresToggleBtn = document.getElementById('featuresToggleBtn');
  const featuresPanel = document.getElementById('featuresPanel');
  
  // Dialog elements
  const dialogs = {
    api: document.getElementById('apiDialog'),
    credits: document.getElementById('creditsDialog'),
    history: document.getElementById('historyDialog'),
    persona: document.getElementById('personaDialog'),
    voice: document.getElementById('voiceDialog'),
    upload: document.getElementById('uploadDialog'),
    dev: document.getElementById('devDialog'),
    background: document.getElementById('backgroundDialog'),
    model: document.getElementById('modelDialog'),
  };
  
  // Mode indicators
  const onlineIndicator = document.getElementById('onlineIndicator');
  const offlineIndicator = document.getElementById('offlineIndicator');
  const hybridIndicator = document.getElementById('hybridIndicator');
  const currentModeText = document.getElementById('currentModeText');

  // Initialize UI
  function initVoiceSettings() {
    // Load available voices
    voices = speechSynthesis.getVoices();
    
    // If voices aren't loaded yet, wait for them
    if (voices.length === 0) {
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        populateVoiceOptions();
      };
    } else {
      populateVoiceOptions();
    }
    
    // Set auto-speak toggle
    document.getElementById('autoSpeakToggle').checked = autoSpeak;
    
    // Set persona input
    document.getElementById('personaInput').value = currentPersona;
    
    // Load uploaded files display
    updateUploadedFilesDisplay();
  }

  function initBackgroundSettings() {
    // Apply saved background
    applyBackground(currentBackground);
    
    // Populate background options
    const backgroundOptions = document.getElementById('backgroundOptions');
    backgroundOptions.innerHTML = '';
    
    BACKGROUND_PRESETS.forEach(bg => {
      const option = document.createElement('div');
      option.className = `background-option ${currentBackground === bg.id ? 'selected' : ''}`;
      option.innerHTML = `
        <div class="bg-preview" style="background: ${bg.preview};">
          ${bg.name}
        </div>
        <div class="bg-name">${bg.name}</div>
      `;
      
      option.onclick = () => {
        currentBackground = bg.id;
        localStorage.setItem('background_mode', bg.id);
        applyBackground(bg.id);
        
        // Update selected state
        document.querySelectorAll('.background-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
      };
      
      backgroundOptions.appendChild(option);
    });
  }

  function applyBackground(bgId) {
    const body = document.body;
    const bg = BACKGROUND_PRESETS.find(b => b.id === bgId);
    
    if (!bg) return;
    
    if (bgId === 'default') {
      body.style.background = `
        linear-gradient(rgba(15,18,32,.75), rgba(15,18,32,.75)),
        url('assets/images/bg.png') center/cover no-repeat
      `;
    } else if (bgId === 'none') {
      body.style.background = bg.preview;
    } else {
      body.style.background = bg.preview;
    }
  }

  function initDevMode() {
    // Set up code tabs
    const tabs = document.querySelectorAll('.code-tab');
    const editors = document.querySelectorAll('.code-editor');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        
        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show corresponding editor
        editors.forEach(editor => {
          if (editor.id === `${tabName}Editor`) {
            editor.style.display = 'block';
          } else {
            editor.style.display = 'none';
          }
        });
      });
    });
    
    // Run code button
    document.getElementById('runCodeBtn').onclick = runCode;
    
    // Reset code button
    document.getElementById('resetCodeBtn').onclick = resetCode;
    
    // Run initial code
    setTimeout(runCode, 100);
  }

  function runCode() {
    const htmlCode = document.getElementById('htmlEditor').value;
    const cssCode = document.getElementById('cssEditor').value;
    const jsCode = document.getElementById('jsEditor').value;
    
    const fullCode = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>${cssCode}</style>
      </head>
      <body>
        ${htmlCode}
        <script>${jsCode}<\/script>
      </body>
      </html>
    `;
    
    const frame = document.getElementById('codeOutputFrame');
    const frameDoc = frame.contentDocument || frame.contentWindow.document;
    
    frameDoc.open();
    frameDoc.write(fullCode);
    frameDoc.close();
  }

  function resetCode() {
    if (confirm('Reset all code to default?')) {
      document.getElementById('htmlEditor').value = `<!DOCTYPE html>
<html>
<head>
  <title>My App</title>
</head>
<body>
  <h1>Hello, World!</h1>
  <p>Edit this code to create your own web app.</p>
  <button onclick="showMessage()">Click Me</button>
  <div id="output"></div>
</body>
</html>`;
      
      document.getElementById('cssEditor').value = `body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 50px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  min-height: 100vh;
  margin: 0;
}

h1 {
  font-size: 3em;
  margin-bottom: 20px;
}

p {
  font-size: 1.2em;
  margin-bottom: 30px;
}

button {
  padding: 12px 30px;
  font-size: 1.1em;
  background: white;
  color: #667eea;
  border: none;
  border-radius: 30px;
  cursor: pointer;
  transition: transform 0.3s;
}

button:hover {
  transform: scale(1.05);
}

#output {
  margin-top: 30px;
  font-size: 1.3em;
  font-weight: bold;
}`;
      
      document.getElementById('jsEditor').value = `function showMessage() {
  const output = document.getElementById('output');
  const messages = [
    "Great job! üéâ",
    "Code executed successfully! ‚úÖ",
    "Welcome to App Development Mode! üíª",
    "You're creating amazing apps! ‚ú®",
    "Keep coding! üë®‚Äçüíª"
  ];
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  output.innerHTML = randomMessage;
  
  // Add some animation
  output.style.opacity = '0';
  output.style.transform = 'translateY(20px)';
  
  setTimeout(() => {
    output.style.transition = 'all 0.5s ease';
    output.style.opacity = '1';
    output.style.transform = 'translateY(0)';
  }, 10);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  console.log('App loaded successfully!');
});`;
      
      runCode();
    }
  }

  function populateVoiceOptions() {
    const voiceOptions = document.getElementById('voiceOptions');
    voiceOptions.innerHTML = '';
    
    // Create voice options based on available voices
    const voiceCategories = [
      { id: 'female', name: 'Female Voice', type: 'Standard Female', lang: 'en-US' },
      { id: 'male', name: 'Male Voice', type: 'Standard Male', lang: 'en-US' }
    ];
    
    // Add browser voices if available
    if (voices.length > 0) {
      // Filter English voices
      const englishVoices = voices.filter(v => v.lang.includes('en'));
      
      // Add first female voice if available
      const femaleVoice = englishVoices.find(v => 
        v.name.toLowerCase().includes('female') || 
        v.name.toLowerCase().includes('susan') ||
        v.name.toLowerCase().includes('zira')
      );
      
      // Add first male voice if available
      const maleVoice = englishVoices.find(v => 
        v.name.toLowerCase().includes('male') || 
        v.name.toLowerCase().includes('david') ||
        v.name.toLowerCase().includes('mark')
      );
      
      if (femaleVoice) {
        voiceCategories[0].name = femaleVoice.name;
        voiceCategories[0].type = 'Browser Female Voice';
      }
      
      if (maleVoice) {
        voiceCategories[1].name = maleVoice.name;
        voiceCategories[1].type = 'Browser Male Voice';
      }
    }
    
    voiceCategories.forEach(voice => {
      const option = document.createElement('div');
      option.className = `voice-option ${selectedVoice === voice.id ? 'selected' : ''}`;
      option.innerHTML = `
        <input type="radio" name="voice" value="${voice.id}" ${selectedVoice === voice.id ? 'checked' : ''}>
        <div class="voice-label">
          <div class="voice-name">${voice.name}</div>
          <div class="voice-type">${voice.type}</div>
        </div>
        <button class="voice-preview">‚ñ∂Ô∏è</button>
      `;
      
      const radioBtn = option.querySelector('input');
      radioBtn.addEventListener('change', (e) => {
        selectedVoice = e.target.value;
        localStorage.setItem('selected_voice', selectedVoice);
        
        // Update selected state
        document.querySelectorAll('.voice-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
      });
      
      const previewBtn = option.querySelector('.voice-preview');
      previewBtn.onclick = () => {
        const tempVoice = selectedVoice;
        selectedVoice = voice.id;
        speakText("This is a preview of the selected voice. The text to speech system is working correctly.");
        selectedVoice = tempVoice;
      };
      
      voiceOptions.appendChild(option);
    });
  }

  // Initialize audio buttons for all AI messages
  function initAudioButtons() {
    const aiMessages = document.querySelectorAll('.msg.ai');
    aiMessages.forEach(message => {
      const audioControls = message.querySelector('.audio-controls-container');
      if (audioControls) {
        const speakBtn = audioControls.querySelector('.speak-btn');
        const stopBtn = audioControls.querySelector('.stop-btn');
        
        if (speakBtn) {
          speakBtn.onclick = () => {
            // Get the text content from the message
            const messageText = message.querySelector('.formatted-text')?.innerText || 
                               message.innerText.replace('üîä Speak‚èπÔ∏è Stop', '').trim();
            speakText(messageText);
          };
        }
        
        if (stopBtn) {
          stopBtn.onclick = stopSpeaking;
        }
      }
    });
  }

  // Speech functions
  function speakText(text) {
    if (!speechSynthesis) {
      console.warn('Speech synthesis not available');
      return;
    }
    
    // Stop any current speech
    if (isSpeaking) {
      stopSpeaking();
    }
    
    // Clean text for speech (remove markdown, etc.)
    const cleanText = text
      .replace(/[#*`\[\]<>]/g, '')
      .replace(/\n/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    
    if (!cleanText) {
      console.warn('No text to speak');
      return;
    }
    
    currentUtterance = new SpeechSynthesisUtterance(cleanText);
    isSpeaking = true;
    
    // Update UI to show speaking state
    updateSpeakingUI(true);
    
    currentUtterance.onend = function() {
      isSpeaking = false;
      currentSpeakingMessage = null;
      updateSpeakingUI(false);
    };
    
    currentUtterance.onerror = function() {
      isSpeaking = false;
      currentSpeakingMessage = null;
      updateSpeakingUI(false);
    };
    
    // Set voice based on selection
    const availableVoices = speechSynthesis.getVoices();
    
    if (availableVoices.length > 0) {
      let voiceToUse = null;
      
      if (selectedVoice === 'female') {
        // Try to find a female voice
        voiceToUse = availableVoices.find(v => 
          v.lang.includes('en') && 
          (v.name.toLowerCase().includes('female') || 
           v.name.toLowerCase().includes('susan') ||
           v.name.toLowerCase().includes('zira'))
        );
      } else if (selectedVoice === 'male') {
        // Try to find a male voice
        voiceToUse = availableVoices.find(v => 
          v.lang.includes('en') && 
          (v.name.toLowerCase().includes('male') || 
           v.name.toLowerCase().includes('david') ||
           v.name.toLowerCase().includes('mark'))
        );
      }
      
      // If no specific voice found, use first English voice
      if (!voiceToUse) {
        voiceToUse = availableVoices.find(v => v.lang.includes('en')) || availableVoices[0];
      }
      
      if (voiceToUse) {
        currentUtterance.voice = voiceToUse;
      }
    }
    
    currentUtterance.rate = 1.0;
    currentUtterance.pitch = 1.0;
    currentUtterance.volume = 1.0;
    
    speechSynthesis.speak(currentUtterance);
  }

  function stopSpeaking() {
    if (speechSynthesis && isSpeaking) {
      speechSynthesis.cancel();
      isSpeaking = false;
      currentSpeakingMessage = null;
      updateSpeakingUI(false);
    }
  }

  function updateSpeakingUI(speaking) {
    // Update all speak/stop buttons in the chat
    const aiMessages = document.querySelectorAll('.msg.ai');
    
    aiMessages.forEach(message => {
      const audioControls = message.querySelector('.audio-controls-container');
      if (audioControls) {
        const speakBtn = audioControls.querySelector('.speak-btn');
        const stopBtn = audioControls.querySelector('.stop-btn');
        
        if (speakBtn) {
          speakBtn.disabled = speaking;
          speakBtn.style.opacity = speaking ? '0.5' : '1';
        }
        
        if (stopBtn) {
          stopBtn.disabled = !speaking;
          stopBtn.style.opacity = !speaking ? '0.5' : '1';
        }
      }
    });
    
    // Update voice playing indicator
    const voicePlayingIndicator = document.getElementById('voicePlayingIndicator');
    if (speaking) {
      if (!voicePlayingIndicator) {
        const hint = document.querySelector('.hint');
        const indicator = document.createElement('span');
        indicator.id = 'voicePlayingIndicator';
        indicator.className = 'voice-playing-indicator';
        indicator.innerHTML = 'üîä Speaking...';
        hint.appendChild(indicator);
      }
    } else {
      if (voicePlayingIndicator) {
        voicePlayingIndicator.remove();
      }
    }
  }

  // Update mode indicators
  function updateModeIndicators() {
    if (OFFLINE_MODE_ENABLED) {
      // Hybrid mode
      onlineIndicator.style.opacity = '0.5';
      offlineIndicator.style.opacity = '0.5';
      hybridIndicator.style.opacity = '1';
      currentModeText.textContent = 'Current: Hybrid Mode';
    } else if (GROQ_API_KEY) {
      // Online mode
      onlineIndicator.style.opacity = '1';
      offlineIndicator.style.opacity = '0.5';
      hybridIndicator.style.opacity = '0.5';
      currentModeText.textContent = 'Current: Online Mode';
    } else {
      // Offline mode
      onlineIndicator.style.opacity = '0.5';
      offlineIndicator.style.opacity = '1';
      hybridIndicator.style.opacity = '0.5';
      currentModeText.textContent = 'Current: Offline Mode';
    }
  }

  // Voice recognition
  let recognition = null;
  let isListening = false;

  function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onstart = () => {
        isListening = true;
        micBtn.classList.add('listening');
        micBtn.textContent = 'üî¥';
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        q.value = transcript;
        micBtn.classList.remove('listening');
        micBtn.textContent = 'üé§';
        isListening = false;
        
        // Auto-send if it sounds like a question
        if (transcript.trim().endsWith('?')) {
          setTimeout(() => ask(), 500);
        }
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        micBtn.classList.remove('listening');
        micBtn.textContent = 'üé§';
        isListening = false;
      };
      
      recognition.onend = () => {
        if (isListening) {
          setTimeout(() => recognition.start(), 100);
        } else {
          micBtn.classList.remove('listening');
          micBtn.textContent = 'üé§';
        }
      };
    } else {
      micBtn.style.display = 'none';
    }
  }

  // Microphone button handler
  micBtn.onclick = () => {
    if (!recognition) {
      initVoiceRecognition();
      return;
    }
    
    if (isListening) {
      recognition.stop();
      isListening = false;
      micBtn.classList.remove('listening');
      micBtn.textContent = 'üé§';
    } else {
      try {
        recognition.start();
      } catch (e) {
        console.error('Failed to start recognition:', e);
      }
    }
  };

  // Features panel toggle
  featuresToggleBtn.onclick = (e) => {
    e.stopPropagation();
    featuresPanel.classList.toggle('show');
  };

  // Close features panel when clicking outside
  document.addEventListener('click', (e) => {
    if (!featuresPanel.contains(e.target) && e.target !== featuresToggleBtn) {
      featuresPanel.classList.remove('show');
    }
  });

  // Dialog management
  function showDialog(dialogName) {
    // Hide all dialogs and features panel
    Object.values(dialogs).forEach(dialog => {
      dialog.classList.remove('show');
    });
    featuresPanel.classList.remove('show');
    
    // Show overlay and selected dialog
    dialogOverlay.classList.add('show');
    dialogs[dialogName].classList.add('show');
    
    // Initialize specific dialogs
    if (dialogName === 'dev') {
      initDevMode();
    }
  }

  function hideAllDialogs() {
    dialogOverlay.classList.remove('show');
    Object.values(dialogs).forEach(dialog => {
      dialog.classList.remove('show');
    });
  }

  // Model selection - currentModel in global scope
  // List of valid models (only confirmed working models)
  const validModels = [
    'llama-3.3-70b-versatile',
    'llama-3.1-8b-instant',
    'llama-3.1-70b-versatile',
    'mixtral-8x7b-32768',
    'gemma2-9b-it'
  ];
  
  let currentModel = localStorage.getItem('selected_model') || 'llama-3.1-8b-instant';
  
  // Reset to default if selected model is invalid/deprecated
  if (!validModels.includes(currentModel)) {
    currentModel = 'llama-3.1-8b-instant';
    localStorage.setItem('selected_model', currentModel);
  }

  // Initialize event listeners
  function initEventListeners() {
    // Dialog open buttons
    document.getElementById('openApiDialog').onclick = () => showDialog('api');
    document.getElementById('openCreditsDialog').onclick = () => showDialog('credits');
    document.getElementById('openHistoryBtn').onclick = () => {
      loadHistory();
      showDialog('history');
    };
    document.getElementById('openPersonaBtn').onclick = () => {
      document.getElementById('personaInput').value = currentPersona;
      showDialog('persona');
    };
    document.getElementById('openVoiceBtn').onclick = () => showDialog('voice');
    document.getElementById('openUploadBtn').onclick = () => {
      updateUploadedFilesDisplay();
      showDialog('upload');
    };
    document.getElementById('openDevModeBtn').onclick = () => showDialog('dev');
    document.getElementById('openBackgroundBtn').onclick = () => showDialog('background');
    
    // Dialog close buttons
    document.getElementById('closeApiDialog').onclick = hideAllDialogs;
    document.getElementById('closeCreditsDialog').onclick = hideAllDialogs;
    document.getElementById('closeModelDialog').onclick = hideAllDialogs;
    document.getElementById('openModelDialog').onclick = () => showDialog('model');
    
    // Model selection functionality
    
    // Update current model display
    function updateCurrentModelDisplay() {
      const modelNames = {
        'llama-3.3-70b-versatile': 'Llama 3.3 70B Versatile',
        'llama-3.1-8b-instant': 'Llama 3.1 8B Instant',
        'llama-3.1-70b-versatile': 'Llama 3.1 70B Versatile',
        'mixtral-8x7b-32768': 'Mixtral 8x7B',
        'gemma2-9b-it': 'Gemma 2 9B'
      };
      
      const displayElement = document.getElementById('currentModelDisplay');
      if (displayElement) {
        displayElement.textContent = modelNames[currentModel] || currentModel;
      }
      
      // Highlight selected model
      document.querySelectorAll('.model-option').forEach(btn => {
        if (btn.dataset.model === currentModel) {
          btn.style.background = 'rgba(108, 242, 194, 0.25)';
          btn.style.borderColor = 'var(--accent)';
        } else {
          btn.style.background = btn.style.background.replace('0.25', '0.1');
        }
      });
    }
    
    // Model option click handlers
    document.querySelectorAll('.model-option').forEach(button => {
      button.addEventListener('click', function() {
        currentModel = this.dataset.model;
        localStorage.setItem('selected_model', currentModel);
        updateCurrentModelDisplay();
        
        // Show confirmation
        const originalText = this.innerHTML;
        this.innerHTML = '<div style="font-weight: 600; color: var(--accent);">‚úì Model Selected!</div>';
        setTimeout(() => {
          this.innerHTML = originalText;
        }, 1000);
      });
      
      // Hover effects
      button.addEventListener('mouseenter', function() {
        if (this.dataset.model !== currentModel) {
          this.style.transform = 'translateX(5px)';
          this.style.background = this.style.background.replace('0.1', '0.15');
        }
      });
      
      button.addEventListener('mouseleave', function() {
        this.style.transform = 'translateX(0)';
        if (this.dataset.model !== currentModel) {
          this.style.background = this.style.background.replace('0.15', '0.1');
        }
      });
    });
    
    // Initialize model display
    updateCurrentModelDisplay();
    
    document.getElementById('closeCreditsBtn').onclick = hideAllDialogs;
    document.getElementById('closeHistoryDialog').onclick = hideAllDialogs;
    document.getElementById('closeHistoryBtn').onclick = hideAllDialogs;
    document.getElementById('closePersonaDialog').onclick = hideAllDialogs;
    document.getElementById('closeVoiceDialog').onclick = hideAllDialogs;
    document.getElementById('closeVoiceBtn').onclick = hideAllDialogs;
    document.getElementById('closeUploadDialog').onclick = hideAllDialogs;
    document.getElementById('closeUploadBtn').onclick = hideAllDialogs;
    document.getElementById('closeDevDialog').onclick = hideAllDialogs;
    document.getElementById('closeDevBtn').onclick = hideAllDialogs;
    document.getElementById('closeBackgroundDialog').onclick = hideAllDialogs;
    document.getElementById('closeBackgroundBtn').onclick = hideAllDialogs;
    
    // Overlay click
    dialogOverlay.onclick = hideAllDialogs;
    
    // Clear chat button
    document.getElementById('clearChatBtn').onclick = () => {
      if (confirm('Clear all chat messages?')) {
        chat.innerHTML = '<div class="msg ai"><div class="formatted-text"><p>Hello! I am Ramanujan Public School AI assistant. How can I help you today?</p><div class="audio-controls-container"><button class="speak-btn">üîä Speak</button><button class="stop-btn" disabled>‚èπÔ∏è Stop</button></div></div></div>';
        conversationMemory.clear();
        initAudioButtons();
      }
    };
    
    // API Key management
    document.getElementById('saveKey').onclick = () => {
      const apiInput = document.getElementById('apiInput');
      const v = apiInput.value.trim();
      if (v) {
        if (v.length < 20) {
          apiStatus.textContent = '‚ùå Key seems too short. Please check.';
          apiStatus.className = 'api-status invalid';
          return;
        }
        localStorage.setItem('GROQ_API_KEY', v);
        GROQ_API_KEY = v;
        updateApiStatus();
        updateModeIndicators();
        hideAllDialogs();
        addMessageToChat('Groq API key saved successfully!', 'ai');
      }
    };
    
    document.getElementById('clearKey').onclick = () => {
      localStorage.removeItem('GROQ_API_KEY');
      GROQ_API_KEY = null;
      document.getElementById('apiInput').value = '';
      updateApiStatus();
      updateModeIndicators();
      addMessageToChat('API key cleared.', 'ai');
    };
    
    document.getElementById('testKey').onclick = async () => {
      if (!GROQ_API_KEY) {
        apiStatus.textContent = '‚ùå No API key to test';
        apiStatus.className = 'api-status invalid';
        return;
      }
      apiStatus.textContent = 'üîÑ Testing Groq API key...';
      apiStatus.className = 'api-status';
      try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GROQ_API_KEY}`
          },
          body: JSON.stringify({
            messages: [{ role: 'user', content: 'Say "API test successful" if you can read this.' }],
            model: currentModel,
            max_tokens: 20
          })
        });
        if (response.ok) {
          apiStatus.textContent = '‚úÖ Groq API key is working!';
          apiStatus.className = 'api-status valid';
        } else {
          const error = await response.json();
          let errorMsg = `‚ùå API error: ${error.error?.message || 'Unknown error'}`;
          apiStatus.textContent = errorMsg;
          apiStatus.className = 'api-status invalid';
        }
      } catch (err) {
        apiStatus.textContent = '‚ùå Network error - check connection';
        apiStatus.className = 'api-status invalid';
      }
    };
    
    // Persona settings
    document.getElementById('savePersonaBtn').onclick = () => {
      const persona = document.getElementById('personaInput').value.trim();
      if (persona) {
        localStorage.setItem('AI_PERSONA', persona);
        currentPersona = persona;
        addMessageToChat('AI persona settings saved!', 'ai');
      } else {
        localStorage.removeItem('AI_PERSONA');
        currentPersona = '';
        addMessageToChat('AI persona settings cleared.', 'ai');
      }
      hideAllDialogs();
    };
    
    document.getElementById('clearPersonaBtn').onclick = () => {
      document.getElementById('personaInput').value = '';
    };
    
    // Voice settings
    document.getElementById('autoSpeakToggle').onchange = (e) => {
      autoSpeak = e.target.checked;
      localStorage.setItem('auto_speak', autoSpeak);
    };
    
    // History
    document.getElementById('clearHistoryBtn').onclick = () => {
      if (confirm('Clear all chat history?')) {
        conversationMemory.clear();
        loadHistory();
      }
    };
    
    // File upload
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.onclick = () => fileInput.click();
    
    fileInput.onchange = handleFileUpload;
    
    uploadArea.ondragover = (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    };
    
    uploadArea.ondragleave = () => {
      uploadArea.classList.remove('dragover');
    };
    
    uploadArea.ondrop = (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload({ target: { files } });
      }
    };
    
    document.getElementById('clearFilesBtn').onclick = () => {
      if (confirm('Clear all uploaded files?')) {
        fileStorage.clearAll();
        updateUploadedFilesDisplay();
        addMessageToChat('All uploaded files have been cleared.', 'ai');
      }
    };
    
    // Mode indicators click handlers
    onlineIndicator.onclick = () => {
      OFFLINE_MODE_ENABLED = false;
      localStorage.setItem('OFFLINE_MODE_ENABLED', 'false');
      updateModeIndicators();
      addMessageToChat('Switched to Online Mode. All queries will use the AI API.', 'ai');
    };
    
    offlineIndicator.onclick = () => {
      OFFLINE_MODE_ENABLED = true;
      localStorage.setItem('OFFLINE_MODE_ENABLED', 'true');
      updateModeIndicators();
      addMessageToChat('Switched to Offline Mode. Only basic queries will be answered.', 'ai');
    };
    
    hybridIndicator.onclick = () => {
      OFFLINE_MODE_ENABLED = true;
      localStorage.setItem('OFFLINE_MODE_ENABLED', 'true');
      updateModeIndicators();
      addMessageToChat('Switched to Hybrid Mode. Simple queries use offline knowledge, complex ones use AI API.', 'ai');
    };
    
    // Send button and input
    send.onclick = ask;
    q.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ask();
      }
    });
  }

  // Update API status
  function updateApiStatus() {
    const apiStatus = document.getElementById('apiStatus');
    if (GROQ_API_KEY) {
      const maskedKey = `${GROQ_API_KEY.substring(0, 10)}...${GROQ_API_KEY.substring(GROQ_API_KEY.length - 4)}`;
      apiStatus.textContent = `‚úÖ API Key saved: ${maskedKey}`;
      apiStatus.className = 'api-status valid';
    } else {
      apiStatus.textContent = 'üî¥ No API key saved (Offline mode only)';
      apiStatus.className = 'api-status invalid';
    }
  }

  // File upload handling
  async function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    
    for (const file of files) {
      if (file.size > 2 * 1024 * 1024) { // 2MB limit
        addMessageToChat(`File "${file.name}" is too large (max 2MB)`, 'ai');
        continue;
      }
      
      if (file.type !== 'text/plain' && !file.name.endsWith('.txt')) {
        addMessageToChat(`File "${file.name}" is not a text file. Please upload .txt files only.`, 'ai');
        continue;
      }
      
      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          const content = e.target.result;
          
          // Store the file
          fileStorage.addFile(file.name, content, file.size);
          updateUploadedFilesDisplay();
          
          // Show success message
          addMessageToChat(`File "${file.name}" uploaded successfully! You can now ask questions about its content.`, 'ai');
          
          // Update file input in chat for reference
          const fileContentPreview = content.length > 200 ? content.substring(0, 200) + '...' : content;
          addMessageToChat(`üìÑ Uploaded file: ${file.name}\nContent preview: ${fileContentPreview}`, 'user');
        } catch (error) {
          console.error('Error reading file:', error);
          addMessageToChat(`Error reading file "${file.name}"`, 'ai');
        }
      };
      
      reader.onerror = () => {
        addMessageToChat(`Error reading file "${file.name}"`, 'ai');
      };
      
      reader.readAsText(file);
    }
    
    // Reset file input
    fileInput.value = '';
  }

  function updateUploadedFilesDisplay() {
    const uploadedFilesDiv = document.getElementById('uploadedFiles');
    const files = fileStorage.getFiles();
    
    if (files.length === 0) {
      uploadedFilesDiv.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No files uploaded yet</div>';
      return;
    }
    
    let html = '';
    files.forEach(file => {
      const size = formatFileSize(file.size);
      const date = new Date(file.uploaded).toLocaleDateString();
      html += `
        <div class="uploaded-file">
          <div>
            <div class="file-name">${file.name}</div>
            <div class="file-size">${size} ‚Ä¢ ${date}</div>
          </div>
          <button class="remove-file">√ó</button>
        </div>
      `;
    });
    
    uploadedFilesDiv.innerHTML = html;
    
    // Add event listeners to remove buttons
    uploadedFilesDiv.querySelectorAll('.remove-file').forEach((btn, index) => {
      btn.onclick = () => {
        const fileId = files[index].id;
        fileStorage.removeFile(fileId);
        updateUploadedFilesDisplay();
        addMessageToChat('File removed from storage.', 'ai');
      };
    });
  }

  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // History loading
  function loadHistory() {
    const historyContent = document.getElementById('historyContent');
    const messages = conversationMemory.getFullHistory();
    
    if (messages.length === 0) {
      historyContent.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No chat history yet</div>';
      return;
    }
    
    let html = '';
    messages.forEach((msg, index) => {
      const time = new Date(msg.timestamp).toLocaleString();
      const role = msg.role === 'user' ? 'üë§ You' : 'ü§ñ AI';
      const content = msg.content.length > 150 ? msg.content.substring(0, 150) + '...' : msg.content;
      
      html += `
        <div class="history-item">
          <div class="history-header">
            <div class="history-role">${role}</div>
            <div class="history-time">${time}</div>
          </div>
          <div class="history-content">${content.replace(/\n/g, ' ')}</div>
        </div>
      `;
    });
    
    historyContent.innerHTML = html;
  }

  // Enhanced Knowledge Base
  const SCHOOL_KB = `Ramanujan Public School is a co-educational English-medium senior secondary school located in Jhalwa, Prayagraj (formerly Allahabad), Uttar Pradesh, India. It's affiliated with the Central Board of Secondary Education (CBSE) and offers classes from nursery up to class 12.

üè´ About the School
‚Ä¢ Founded: 1995 AD
‚Ä¢ Location: Sahapur Urf Peepalgaon, Opposite IIIT, Jhalwa, Prayagraj ‚Äì 211012, Uttar Pradesh
‚Ä¢ Affiliation: CBSE (Affiliation number 2130472)
‚Ä¢ Contact: Phone: +91-7752922226, Email: rpsjhalwa.all@gmail.com

üìå Founders / Managing Organization
Ramanujan Public School was established by the Brij Nath Dina Nath (BNDN) Memorial Educational Society in memory of Lt. Brij Nath and Lt. Dr. Dina Nath. It was founded under the leadership of Dr. Gyan Chandra Srivastava, who is the Founder and Chairman of the Ramanujan Group of Educational Institutions (RGEI), which manages the school.

This AI assistant was created by students of Class IX-B of Ramanujan Public School as an educational project. It was developed, compiled, and debugged by Priyansh Sinha with assistance from AI systems.`;

  const JAGANNATH_KB = `Lord Jagannath is a deity worshipped in the Hindu tradition, primarily in the Indian state of Odisha. Here is comprehensive information about Lord Jagannath:

**Origin and Significance:**
- Lord Jagannath is considered a form of Lord Vishnu and Lord Krishna
- The name "Jagannath" means "Lord of the Universe" (Jagat = Universe, Nath = Lord)
- The deity is worshipped along with his elder brother Balabhadra (Balarama) and sister Subhadra
- The wooden deities are made from neem wood (daru brahma)

**Jagannath Temple, Puri:**
- Located in Puri, Odisha, on the eastern coast of India
- One of the Char Dham pilgrimage sites for Hindus
- Temple was built by King Anantavarman Chodaganga Deva of the Eastern Ganga dynasty in the 12th century
- The temple complex covers an area of over 400,000 square feet
- The main temple is 214 feet high

**Unique Features:**
1. **Wooden Idols:** Unlike stone or metal idols in most temples, Jagannath idols are made of wood
2. **Nabakalebara:** The ritual renewal of the wooden idols every 12-19 years based on the lunar calendar
3. **No Shadow:** The temple doesn't cast any shadow at any time of the day (architectural marvel)
4. **Flag Always Flutters:** The flag on top of the temple always flutters in the opposite direction of the wind
5. **Sudarshan Chakra:** The chakra on top of the temple looks the same from every direction

**Rath Yatra (Chariot Festival):**
- The most famous festival associated with Lord Jagannath
- Occurs annually in June or July (Ashadha month)
- The deities are taken out of the temple on three massive chariots:
  * Nandighosa (Jagannath's chariot): 45 feet high, 16 wheels
  * Taladhwaja (Balabhadra's chariot): 44 feet high, 14 wheels
  * Darpadalana (Subhadra's chariot): 43 feet high, 12 wheels
- The festival lasts for 9 days
- Millions of devotees participate in pulling the chariots

**Associated Traditions:**
- **Mahaprasad:** The temple food offered to Jagannath, considered highly sacred
- **Anavasara:** The 15-day period after Snana Purnima when deities are believed to fall sick
- **Niladri Bije:** The return journey of deities to the temple after Rath Yatra

**Philosophical Significance:**
- Jagannath represents the universal, formless supreme reality
- The deity symbolizes equality - all devotees are equal before Jagannath
- The temple has no restrictions based on caste, creed, or religion
- Represents the synthesis of different Hindu traditions (Vaishnavism, Shaivism, Shaktism)

**Cultural Impact:**
- Jagannath culture has spread to various parts of India and Southeast Asia
- The ISKCON movement worships Jagannath as a principal deity
- References in medieval Indian literature and poetry
- Influenced art, music, dance, and architecture in Odisha

**Interesting Facts:**
- The eyes of Jagannath idols are disproportionately large
- The deities are incomplete (no hands or feet) - symbolizing that God is beyond human form
- The cooking process in the temple kitchen follows unique traditions (food is cooked in earthen pots)
- The temple serves food to thousands of devotees daily, regardless of their background

Lord Jagannath represents the essence of Sanatana Dharma - universal, inclusive, and accessible to all.`;

  const MATH_KB = {
    'pythagoras': 'The Pythagorean theorem states: a¬≤ + b¬≤ = c¬≤, where c is the hypotenuse of a right triangle.',
    'quadratic': 'The quadratic formula: x = [-b ¬± ‚àö(b¬≤ - 4ac)] / 2a',
    'algebra': 'Algebra is the branch of mathematics dealing with symbols and rules for manipulating those symbols.',
    'geometry': 'Geometry studies shapes, sizes, positions, and properties of space.',
    'calculus': 'Calculus is the mathematical study of continuous change.',
    'trigonometry': 'Trigonometry deals with relationships between angles and sides of triangles.',
    'statistics': 'Statistics is the study of data collection, analysis, interpretation, and presentation.',
    'probability': 'Probability measures the likelihood of events occurring.'
  };

  // Features description
  const FEATURES_KB = `I have several new features that make me more useful:

**üé§ Voice Input:** Click the microphone button to speak your questions instead of typing
**üîä Voice Output:** I can read responses aloud with selectable male/female voices. Use the stop button to stop playback.
**üìÅ File Upload:** Upload text files and ask questions about their content
**üìú Chat History:** View and manage your conversation history
**üé≠ AI Persona:** Customize how I respond by setting personality instructions
**üîë API Integration:** Connect to Groq AI for more comprehensive answers
**‚ö° Mode Selection:** Choose between Online, Offline, or Hybrid modes
**üíª App Development Mode:** Write HTML/CSS/JavaScript code and run it in real-time
**üé® Background Customization:** Choose from 3 preset backgrounds or no background
**üì± Modern UI:** Clean, responsive interface with animations

**Mode Details:**
- **Online Mode (Green):** All queries use AI API
- **Offline Mode (Red):** Only basic knowledge base queries
- **Hybrid Mode (Yellow):** Simple queries use offline knowledge, complex ones use AI

To access these features, click the ‚öôÔ∏è Features button in the top right.`;

  // Offline reply function
  function offlineReply(text) {
    if (!OFFLINE_MODE_ENABLED) return null;
    
    text = text.toLowerCase().trim();
    
    // Basic greetings
    if (/^(hi|hello|hey|namaste)/i.test(text)) return 'Hello! How may I assist you with your studies today?';
    if (/how are you/i.test(text)) return 'I am functioning well. Ready to help with your questions!';
    if (/what is your name/i.test(text)) return 'I am Ramanujan School AI, created by students of Class IX-B at Ramanujan Public School.';
    if (/who created you/i.test(text)) return 'I was created by students of Class IX-B at Ramanujan Public School, Prayagraj.';
    
    // Check for features question
    if (/what.*features?/i.test(text) || /new features?/i.test(text) || /what can you do/i.test(text)) {
      return FEATURES_KB;
    }
    
    // Check for dev mode
    if (/dev(elopment)? mode|code editor|html editor|write code/i.test(text)) {
      return 'You can access the App Development Mode by clicking the ‚öôÔ∏è Features button and selecting "üíª Dev Mode". There you can write HTML, CSS, and JavaScript code and run it in real-time!';
    }
    
    // Check for background mode
    if (/background|theme|color scheme|change look/i.test(text)) {
      return 'You can change the background by clicking the ‚öôÔ∏è Features button and selecting "üé® Background". There are 3 preset backgrounds and an option for no background.';
    }
    
    // School queries
    if (text.includes('ramanujan school') || text.includes('ramanujan public school') || 
        text.includes('school in jhalwa') || text.includes('rps jhalwa') ||
        text.includes('ramanujan') && text.includes('school')) {
      return SCHOOL_KB;
    }
    
    // Jagannath queries
    if (/jagannath|puri temple|rath yatra|jaganath|jagganath/i.test(text)) {
      return JAGANNATH_KB;
    }
    
    // Math terms
    const mathTerms = ['pythagoras', 'quadratic', 'algebra', 'geometry', 'calculus', 'trigonometry', 'statistics', 'probability'];
    for (const term of mathTerms) {
      if (text.includes(term) && text.split(' ').length < 5) {
        return MATH_KB[term] || null;
      }
    }
    
    // Check uploaded files
    if (text.includes('uploaded file') || text.includes('my file') || text.includes('attached file')) {
      const files = fileStorage.getFiles();
      if (files.length > 0) {
        let fileList = 'You have uploaded these files:\n';
        files.forEach((file, index) => {
          fileList += `${index + 1}. ${file.name} (${formatFileSize(file.size)})\n`;
        });
        fileList += '\nTo ask about a specific file, mention its name or ask about the content directly.';
        return fileList;
      }
    }
    
    return null;
  }

  // Add message to chat
  function addMessageToChat(text, cls, isTyping = false) {
    const d = document.createElement('div');
    d.className = `msg ${cls}`;
    
    if (isTyping) {
      d.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      d.id = 'typing-msg';
    } else {
      const formattedText = formatTextForDisplay(text);
      d.innerHTML = `<div class="formatted-text">${formattedText}</div>`;
      
      // Add audio controls for AI messages
      if (cls === 'ai') {
        const audioControls = document.createElement('div');
        audioControls.className = 'audio-controls-container';
        audioControls.innerHTML = `
          <button class="speak-btn">üîä Speak</button>
          <button class="stop-btn" disabled>‚èπÔ∏è Stop</button>
        `;
        
        // Add event listeners
        const speakBtn = audioControls.querySelector('.speak-btn');
        const stopBtn = audioControls.querySelector('.stop-btn');
        
        speakBtn.onclick = () => {
          speakText(text);
        };
        
        stopBtn.onclick = stopSpeaking;
        
        d.querySelector('.formatted-text').appendChild(audioControls);
      }
    }
    
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return d;
  }

  function removeTypingIndicator() {
    const typingMsg = document.getElementById('typing-msg');
    if (typingMsg) typingMsg.remove();
  }

  // Main ask function
  async function ask() {
    const text = q.value.trim();
    if (!text) return;
    
    q.value = '';
    
    // Add user message to chat and memory
    addMessageToChat(text, 'user');
    conversationMemory.addMessage('user', text);
    
    send.disabled = true;
    q.disabled = true;
    micBtn.disabled = true;

    let typingIndicator = null;
    
    // Check for offline reply first
    if (OFFLINE_MODE_ENABLED) {
      const localReply = offlineReply(text);
      if (localReply) {
        typingIndicator = addMessageToChat('', 'ai', true);
        
        setTimeout(() => {
          removeTypingIndicator();
          addMessageToChat(localReply, 'ai');
          conversationMemory.addMessage('assistant', localReply);
          
          // Auto-speak if enabled
          if (autoSpeak) {
            speakText(localReply);
          }
          
          send.disabled = false;
          q.disabled = false;
          micBtn.disabled = false;
          q.focus();
        }, 500);
        return;
      }
    }

    // If no API key but we need online mode
    if (!GROQ_API_KEY && !OFFLINE_MODE_ENABLED) {
      addMessageToChat('To use online features, please add your Groq API key by clicking the ‚öôÔ∏è Features button and selecting "API Key".', 'ai');
      send.disabled = false;
      q.disabled = false;
      micBtn.disabled = false;
      q.focus();
      showDialog('api');
      return;
    }

    // If no API key and offline mode can't handle it
    if (!GROQ_API_KEY) {
      addMessageToChat('I couldn\'t find an answer in my offline knowledge. Please add an API key for online queries or ask simpler questions about school info, Lord Jagannath, or basic math.', 'ai');
      send.disabled = false;
      q.disabled = false;
      micBtn.disabled = false;
      q.focus();
      return;
    }

    // Show typing indicator for online request
    typingIndicator = addMessageToChat('', 'ai', true);

    try {
      // Check uploaded files for context
      const files = fileStorage.getFiles();
      let fileContext = '';
      if (files.length > 0) {
        fileContext = '\n\nUser has uploaded these files that you can reference:\n';
        files.forEach((file, index) => {
          fileContext += `${index + 1}. ${file.name}: ${file.content.substring(0, 200)}...\n`;
        });
      }

      // Build system message with persona
      const systemMessage = currentPersona 
        ? `${currentPersona}\n\nYou are Ramanujan School AI created by students.${fileContext}\n\nIMPORTANT: When users ask about "CBSE", provide information about the educational board, not just the school.`
        : `You are Ramanujan School AI, a helpful assistant created by students of Ramanujan Public School in Prayagraj, Jhalwa.${fileContext}\n\nIMPORTANT: When users ask about "CBSE", provide information about the educational board, not just the school. Format answers with proper paragraphs, lists, and spacing. Use markdown formatting.`;

      // Build messages array with conversation history
      const contextMessages = conversationMemory.getContextMessages();
      const messages = [
        {
          role: 'system',
          content: systemMessage
        },
        ...contextMessages.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content
        })),
        {
          role: 'user',
          content: text
        }
      ];

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${GROQ_API_KEY}`
        },
        body: JSON.stringify({
          messages: messages,
          model: currentModel,
          temperature: 0.7,
          max_tokens: 1000
        })
      });
      
      removeTypingIndicator();
      
      if (!response.ok) {
        const error = await response.json();
        let errorMsg = '';
        if (error.error?.type === 'invalid_request_error') {
          errorMsg = '**API Key Error**\n\nPlease check your API key is valid.';
          updateApiStatus();
        } else if (error.error?.code === 'rate_limit_exceeded') {
          errorMsg = '**Rate Limit Reached**\n\nPlease wait a moment before sending more questions.';
        } else {
          errorMsg = `**Error**: ${error.error?.message || 'Unknown error'}`;
        }
        addMessageToChat(errorMsg, 'ai');
      } else {
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || 'I received an empty response. Please try again.';
        addMessageToChat(reply, 'ai');
        conversationMemory.addMessage('assistant', reply);
        
        // Auto-speak if enabled
        if (autoSpeak) {
          speakText(reply);
        }
      }
    } catch (err) {
      removeTypingIndicator();
      console.error('Request failed:', err);
      addMessageToChat('**Network Error**\n\nPlease check your connection and try again.', 'ai');
    }
    
    send.disabled = false;
    q.disabled = false;
    micBtn.disabled = false;
    q.focus();
  }

  // Initialize everything when the page loads
  window.addEventListener('load', () => {
    q.focus();
  });
  
  // ======================
  // CODE RUNNER FUNCTIONS
  // ======================
  function showCodeRunner(code) {
    document.body.classList.add('split-mode');
    const frame = document.getElementById('codeRunnerFrame');
    const blob = new Blob([code], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    frame.src = url;
  }
  
  function closeCodeRunner() {
    document.body.classList.remove('split-mode');
    const frame = document.getElementById('codeRunnerFrame');
    frame.src = '';
  }
  
  function runCodeFromMessage(code) {
    showCodeRunner(code);
  }
  
  function copyCode(button) {
    const codeBlock = button.closest('.code-container').querySelector('code');
    const text = codeBlock.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
      const originalText = button.textContent;
      button.textContent = '‚úì Copied!';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    });
  }
  
  // Update formatTextForDisplay to handle code blocks with run buttons
  formatTextForDisplay = function(text) {
    let formatted = text;
    
    // Check if this has code blocks
    const hasCodeBlock = /```/.test(text);
    const hasHTMLTags = /<\/?[a-z][\s\S]*>/i.test(text) && !text.includes('<div') && !text.includes('<span');
    
    if (hasCodeBlock) {
      // Process code blocks with language detection
      formatted = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        lang = lang || 'code';
        const displayLang = lang.toLowerCase();
        const highlightedCode = highlightCode(code.trim(), displayLang);
        
        // Determine if code can be run (HTML, CSS+HTML, or JavaScript+HTML)
        const isRunnable = ['html', 'htm', 'xml'].includes(displayLang);
        const runButton = isRunnable ? 
          `<button class="code-action-btn run-code-btn" onclick='runCodeFromMessage(\`${code.trim().replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)'>‚ñ∂Ô∏è Run</button>` : '';
        
        return `
          <div class="code-container">
            <div class="code-header">
              <span class="code-language">${displayLang}</span>
              <div class="code-actions">
                <button class="code-action-btn" onclick="copyCode(this)">üìã Copy</button>
                ${runButton}
              </div>
            </div>
            <pre class="code-block"><code>${highlightedCode}</code></pre>
          </div>
        `;
      });
    } else if (hasHTMLTags) {
      // Wrap raw HTML code
      const highlightedCode = highlightCode(text, 'html');
      formatted = `
        <div class="code-container">
          <div class="code-header">
            <span class="code-language">html</span>
            <div class="code-actions">
              <button class="code-action-btn" onclick="copyCode(this)">üìã Copy</button>
              <button class="code-action-btn run-code-btn" onclick='runCodeFromMessage(\`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)'>‚ñ∂Ô∏è Run</button>
            </div>
          </div>
          <pre class="code-block"><code>${highlightedCode}</code></pre>
        </div>
      `;
    }
    
    // Format markdown
    formatted = formatted
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n- /g, '<br>‚Ä¢ ')
      .replace(/\n/g, '<br>');
    
    if (!formatted.includes('<div class="code-container">')) {
      formatted = '<p>' + formatted + '</p>';
    }
    
    return formatted;
  };
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Simple syntax highlighter
  function highlightCode(code, lang) {
    let highlighted = escapeHtml(code);
    
    if (lang === 'html' || lang === 'htm' || lang === 'xml') {
      // HTML/XML highlighting
      highlighted = highlighted
        // Comments
        .replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="comment">$1</span>')
        // Tags
        .replace(/(&lt;\/?)([\w-]+)/g, '$1<span class="tag">$2</span>')
        // Attributes
        .replace(/([\w-]+)(?==)/g, '<span class="attribute">$1</span>')
        // Attribute values
        .replace(/=(&quot;|&#39;)(.*?)(\1)/g, '=<span class="string">$1$2$3</span>');
        
    } else if (lang === 'css') {
      // CSS highlighting
      highlighted = highlighted
        // Comments
        .replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="comment">$1</span>')
        // Selectors
        .replace(/^([\s]*)([\w\-\.#\[\],:>\+~\*\(\)]+)(\s*\{)/gm, '$1<span class="selector">$2</span>$3')
        // Properties
        .replace(/([\w-]+)(\s*:)/g, '<span class="property">$1</span>$2')
        // Values
        .replace(/:\s*([^;}\n]+)/g, ': <span class="value">$1</span>')
        // Important
        .replace(/!important/g, '<span class="important">!important</span>');
        
    } else if (lang === 'javascript' || lang === 'js') {
      // JavaScript highlighting
      highlighted = highlighted
        // Comments
        .replace(/(\/\/.*$)/gm, '<span class="comment">$1</span>')
        .replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="comment">$1</span>')
        // Strings
        .replace(/(&quot;(?:[^&quot;\\]|\\.)*&quot;|&#39;(?:[^&#39;\\]|\\.)*&#39;|`(?:[^`\\]|\\.)*`)/g, '<span class="string">$1</span>')
        // Numbers
        .replace(/\b(\d+\.?\d*)\b/g, '<span class="number">$1</span>')
        // Keywords
        .replace(/\b(const|let|var|function|if|else|for|while|return|class|import|export|from|async|await|new|this|try|catch|throw|break|continue|switch|case|default)\b/g, '<span class="keyword">$1</span>')
        // Functions
        .replace(/\b([a-zA-Z_]\w*)\s*(?=\()/g, '<span class="function">$1</span>');
        
    } else if (lang === 'python' || lang === 'py') {
      // Python highlighting
      highlighted = highlighted
        // Comments
        .replace(/(#.*$)/gm, '<span class="comment">$1</span>')
        // Strings
        .replace(/(&quot;(?:[^&quot;\\]|\\.)*&quot;|&#39;(?:[^&#39;\\]|\\.)*&#39;)/g, '<span class="string">$1</span>')
        // Keywords
        .replace(/\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|with|lambda|yield|async|await|pass|break|continue)\b/g, '<span class="keyword">$1</span>')
        // Numbers
        .replace(/\b(\d+\.?\d*)\b/g, '<span class="number">$1</span>')
        // Functions
        .replace(/\b([a-zA-Z_]\w*)\s*(?=\()/g, '<span class="function">$1</span>');
    }
    
    return highlighted;
  }
  
  // ======================
  // WORD DOCUMENT SUPPORT
  // ======================
  
</script>
</body>
</html>

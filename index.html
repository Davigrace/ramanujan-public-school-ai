<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ramanujan School AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== 1. STARTUP SCREEN & ANIMATIONS ===== */
    #startupScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(145deg, #0a0e1f 0%, #13172b 50%, #0f1220 100%);
      color: var(--text);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
    }

    .startup-slide {
      text-align: center;
      max-width: 900px;
      width: 90%;
      padding: 40px;
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }
    .startup-slide.active {
      display: block;
      animation: slideUpFadeIn 0.8s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
    }

    @keyframes slideUpFadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes logoPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* School Logo/Image Slide */
    .school-logo-container {
      margin: 0 auto 40px;
      width: 320px;
      height: 320px;
      border-radius: 24px;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      display: grid;
      place-items: center;
      padding: 20px;
      border: 1px solid rgba(108, 242, 194, 0.2);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: logoPulse 3s ease-in-out infinite;
    }
    .school-logo-container img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
    }

    /* Credits Slide */
    .credits-title {
      font-size: 3.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }
    .credits-subtitle {
      font-size: 1.2rem;
      color: var(--muted);
      margin-bottom: 50px;
      font-weight: 300;
    }
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 60px;
    }
    .team-member {
      background: rgba(255, 255, 255, 0.03);
      padding: 25px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      transition: all 0.3s ease;
    }
    .team-member:hover {
      transform: translateY(-8px);
      background: rgba(108, 242, 194, 0.05);
      border-color: rgba(108, 242, 194, 0.3);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }
    .member-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    .member-role {
      font-size: 0.95rem;
      color: var(--accent);
      font-weight: 500;
      background: rgba(108, 242, 194, 0.1);
      padding: 6px 14px;
      border-radius: 100px;
      display: inline-block;
    }

    /* Start Button */
    .start-button {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #071515;
      font-size: 1.3rem;
      font-weight: 700;
      padding: 20px 50px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(108, 242, 194, 0.3);
    }
    .start-button:hover {
      transform: scale(1.05) translateY(-5px);
      box-shadow: 0 15px 40px rgba(108, 242, 194, 0.4);
    }
    .start-button:active {
      transform: scale(0.98);
    }

    /* ===== 2. MAIN APP STYLES ===== */
    :root{
      --bg:#0f1220;
      --card:#161a35;
      --accent:#6cf2c2;
      --accent2:#7aa2ff;
      --text:#e7e9ff;
      --muted:#aab0ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        linear-gradient(rgba(15,18,32,.75), rgba(15,18,32,.75)),
        url('assets/images/bg.png') center/cover no-repeat;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .app{
      width:min(980px, 94vw);
      height:min(620px, 90vh);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
                 var(--card);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(0,0,0,.45);
      display:grid;
      grid-template-rows:auto 1fr auto;
      overflow:hidden;
      position:relative;
      animation: appLoad 0.8s ease-out;
    }
    @keyframes appLoad {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    /* Header */
    header{
      padding:18px 22px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .logo{
      width:38px;
      height:38px;
      border-radius:10px;
      background:rgba(255,255,255,.9);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    header h1{
      font-size:18px;
      margin:0;
    }
    header span{
      color:var(--muted);
      font-size:13px;
    }
    
    /* Action buttons */
    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .action-btn{
      background:rgba(108, 242, 194, 0.1);
      border:1px solid rgba(108, 242, 194, 0.3);
      color:var(--accent);
      padding:6px 12px;
      border-radius:8px;
      font-size:12px;
      cursor:pointer;
      transition:all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .action-btn:hover{
      background:rgba(108, 242, 194, 0.2);
    }
    .clear-btn {
      background: rgba(255, 100, 100, 0.1);
      border: 1px solid rgba(255, 100, 100, 0.3);
      color: #ff7a7a;
    }
    .clear-btn:hover {
      background: rgba(255, 100, 100, 0.2);
    }
    
    /* Mode toggle button */
    .mode-toggle {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #ffc107;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .mode-toggle:hover {
      background: rgba(255, 193, 7, 0.2);
    }
    .mode-toggle.online-mode {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }
    .mode-toggle.online-mode:hover {
      background: rgba(76, 175, 80, 0.2);
    }
    
    /* Chat area */
    .chat{
      padding:18px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .msg{
      max-width:78%;
      padding:12px 14px;
      border-radius:14px;
      line-height:1.45;
      word-wrap:break-word;
      animation: messageSlideIn 0.4s ease-out forwards;
    }
    @keyframes messageSlideIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .user{
      margin-left:auto;
      background:linear-gradient(135deg, #2a3170, #2d3aa6);
      align-self: flex-end;
    }
    .ai{
      background:#202661;
      align-self: flex-start;
    }
    
    /* ===== 3. FORMATTED TEXT STYLES ===== */
    .formatted-text {
      line-height: 1.6;
      font-size: 14px;
    }
    
    .formatted-text p {
      margin-bottom: 1em;
    }
    
    .formatted-text ul, .formatted-text ol {
      margin: 0.5em 0 0.5em 1.5em;
      padding: 0;
    }
    
    .formatted-text li {
      margin-bottom: 0.5em;
    }
    
    .formatted-text strong, .formatted-text b {
      color: var(--accent);
      font-weight: 600;
    }
    
    .formatted-text em, .formatted-text i {
      font-style: italic;
    }
    
    .formatted-text h3, .formatted-text h4 {
      margin: 1em 0 0.5em 0;
      color: var(--accent);
    }
    
    .formatted-text h3 {
      font-size: 1.2em;
      font-weight: 700;
    }
    
    .formatted-text h4 {
      font-size: 1.1em;
      font-weight: 600;
    }
    
    .formatted-text code {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }
    
    .formatted-text blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 1em;
      margin: 1em 0;
      color: var(--muted);
      font-style: italic;
    }
    
    .formatted-text .step {
      margin: 1em 0;
      padding-left: 1.5em;
      position: relative;
    }
    
    .formatted-text .step:before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: var(--accent);
    }
    
    /* Footer */
    footer{
      padding:14px;
      border-top:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .input{
      display:flex;
      gap:10px;
      align-items:center;
      background:#0e1230;
      padding:10px;
      border-radius:14px;
    }
    input{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      transition: box-shadow 0.2s ease;
    }
    input:focus {
      box-shadow: 0 0 0 2px rgba(108, 242, 194, 0.4);
    }
    button{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071515;
      font-weight:700;
      transition:all 0.2s ease;
    }
    button:hover{
      opacity:0.9;
      transform: translateY(-1px);
    }
    button:active{
      transform: scale(0.96);
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform: none !important;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .credits-btn{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      color:var(--muted);
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .credits-btn:hover{
      background:rgba(255,255,255,0.1);
      color:var(--text);
    }
    
    /* Dialogs */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      display: none;
    }
    .dialog-overlay.show {
      display: block;
    }
    
    .api-dialog, .credits-dialog, .history-dialog, .persona-dialog, .voice-dialog, .upload-dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      padding: 25px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .15);
      box-shadow: 0 15px 50px rgba(0, 0, 0, .6);
      width: 450px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 101;
      display: none;
      animation: dialogFadeIn 0.3s ease;
    }
    @keyframes dialogFadeIn {
      from { opacity: 0; transform: translateY(-10px) translate(-50%, -50%); }
      to { opacity: 1; transform: translateY(0) translate(-50%, -50%); }
    }
    .api-dialog.show, .credits-dialog.show, .history-dialog.show, 
    .persona-dialog.show, .voice-dialog.show, .upload-dialog.show {
      display: block;
    }
    
    /* Dialog specific */
    .dialog-content {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .api-dialog h3, .credits-dialog h3, .history-dialog h3, 
    .persona-dialog h3, .voice-dialog h3, .upload-dialog h3 {
      margin: 0 0 20px 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--accent);
    }
    
    .api-dialog h3:before {
      content: "üîë";
      font-size: 18px;
    }
    .history-dialog h3:before {
      content: "üìú";
      font-size: 18px;
    }
    .persona-dialog h3:before {
      content: "üé≠";
      font-size: 18px;
    }
    .voice-dialog h3:before {
      content: "üîä";
      font-size: 18px;
    }
    .upload-dialog h3:before {
      content: "üìÅ";
      font-size: 18px;
    }
    
    .api-input-container {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .api-input, .persona-input {
      flex: 1;
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      resize: vertical;
    }
    .persona-input {
      width: 100%;
      min-height: 120px;
    }
    .api-input:focus, .persona-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Voice selection */
    .voice-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .voice-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .voice-option:hover {
      background: rgba(108, 242, 194, 0.05);
      border-color: rgba(108, 242, 194, 0.3);
    }
    .voice-option.selected {
      background: rgba(108, 242, 194, 0.1);
      border-color: var(--accent);
    }
    .voice-option input[type="radio"] {
      margin: 0;
    }
    .voice-label {
      display: flex;
      flex-direction: column;
    }
    .voice-name {
      font-weight: 600;
      color: var(--text);
    }
    .voice-type {
      font-size: 11px;
      color: var(--muted);
    }
    
    /* Upload area */
    .upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(108, 242, 194, 0.05);
    }
    .upload-area.dragover {
      border-color: var(--accent);
      background: rgba(108, 242, 194, 0.1);
    }
    .upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: var(--accent);
    }
    .upload-text {
      color: var(--text);
      margin-bottom: 5px;
    }
    .upload-subtext {
      color: var(--muted);
      font-size: 12px;
    }
    .uploaded-files {
      margin-top: 20px;
      max-height: 150px;
      overflow-y: auto;
    }
    .uploaded-file {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .file-name {
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-size {
      font-size: 11px;
      color: var(--muted);
    }
    .remove-file {
      background: none;
      border: none;
      color: #ff7a7a;
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
    }
    
    /* Audio controls */
    .audio-controls {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 5px;
    }
    .audio-btn {
      background: rgba(122, 162, 255, 0.1);
      border: 1px solid rgba(122, 162, 255, 0.3);
      color: var(--accent2);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .audio-btn:hover {
      background: rgba(122, 162, 255, 0.2);
    }
    .audio-btn.active {
      background: rgba(108, 242, 194, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* Microphone button */
    .mic-btn {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #ffc107;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
    }
    .mic-btn:hover {
      background: rgba(255, 193, 7, 0.2);
    }
    .mic-btn.listening {
      background: rgba(255, 50, 50, 0.2);
      border-color: #ff3232;
      color: #ff3232;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Status indicators */
    .api-status {
      font-size: 12px;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
      background: rgba(255, 255, 255, .05);
    }
    .api-status.valid {
      color: var(--accent);
      background: rgba(108, 242, 194, 0.1);
    }
    .api-status.invalid {
      color: #ff7a7a;
      background: rgba(255, 122, 122, 0.1);
    }
    .api-actions, .dialog-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .api-actions button, .dialog-actions button {
      padding: 8px 16px;
      font-size: 12px;
    }
    .api-actions .secondary, .dialog-actions .secondary {
      background: rgba(255, 255, 255, .1);
      color: var(--text);
    }
    .api-actions .secondary:hover, .dialog-actions .secondary:hover {
      background: rgba(255, 255, 255, .15);
    }
    .api-help {
      font-size: 11px;
      color: var(--muted);
      margin-top: 12px;
      line-height: 1.4;
    }
    .api-help a {
      color: var(--accent);
      text-decoration: none;
    }
    .api-help a:hover {
      text-decoration: underline;
    }
    
    /* Close buttons */
    .close-dialog {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .close-dialog:hover {
      background: rgba(255, 255, 255, .1);
      color: var(--text);
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
    }
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }
    
    /* Memory indicator */
    .memory-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      background: rgba(108, 242, 194, 0.1);
      border: 1px solid rgba(108, 242, 194, 0.2);
      color: var(--accent);
      margin-left: 10px;
    }
    
    /* Mode indicator */
    .mode-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 5px;
    }
    .mode-status.offline {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #ffc107;
    }
    .mode-status.online-only {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }
    
    /* History items */
    .history-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.07);
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .history-role {
      font-weight: 600;
      color: var(--accent);
    }
    .history-time {
      font-size: 11px;
      color: var(--muted);
    }
    .history-content {
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
  </style>
</head>
<body>
  <!-- ===== STARTUP SCREENS ===== -->
  <div id="startupScreen">
    <!-- Slide 1: School Information -->
    <div class="startup-slide active" id="slideSchool">
      <div class="school-logo-container">
        <img src="assets/images/images.png" alt="Ramanujan Public School" />
      </div>
      <h1 style="font-size: 2.8rem; margin-bottom: 15px;">Ramanujan Public School</h1>
      <p style="font-size: 1.1rem; color: var(--muted); line-height: 1.7; max-width: 600px; margin: 0 auto 30px;">
        Sanapur Urf Pepalgaon (Oppt. IIIT, Jhalwa)<br>
        Allahabad-211012<br>
        Phone: +91-7752922226<br>
        E-mail: rpsjhalwa.all@gmail.com
      </p>
      <p style="font-size: 1.8rem; font-weight: 600; margin-top: 40px; color: var(--accent);">
        Presents
      </p>
      <h2 style="font-size: 3rem; font-weight: 700; background: linear-gradient(90deg, #6cf2c2, #7aa2ff); -webkit-background-clip: text; background-clip: text; color: transparent; margin: 10px 0 40px 0;">
        School AI Assistant
      </h2>
      <button class="start-button" onclick="showNextSlide()">
        Meet the Team <span style="font-size: 1.2rem;">‚Üí</span>
      </button>
    </div>

    <!-- Slide 2: Team Credits -->
    <div class="startup-slide" id="slideTeam">
      <div class="credits-title">Project Credits</div>
      <div class="credits-subtitle">Built with dedication by the students of Class IX-B</div>

      <div class="team-grid">
        <div class="team-member">
          <div class="member-name">Priyansh</div>
          <div class="member-role">Developer & Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Vansh</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Shreyash</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Shreya</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Anshika</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Ananya</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Ankit</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Kashfa</div>
          <div class="member-role">Presenter</div>
        </div>
        <div class="team-member">
          <div class="member-name">Utkarshini</div>
          <div class="member-role">Presenter</div>
        </div>
      </div>

      <button class="start-button" onclick="startChatApp()">
        Start Chatting <span style="font-size: 1.2rem;">üöÄ</span>
      </button>
    </div>
  </div>

  <!-- ===== DIALOG OVERLAY ===== -->
  <div class="dialog-overlay" id="dialogOverlay"></div>

  <!-- ===== MAIN CHAT APP (HIDDEN INITIALLY) ===== -->
  <div class="app" id="mainApp" style="display: none;">
    <!-- Header with all action buttons -->
    <header>
      <div class="logo"><img src="assets/images/logo.png" alt="School Logo"></div>
      <div>
        <h1>Ramanujan School AI <span class="memory-badge">üéØ Context Aware</span></h1>
        <span>Homework help ‚Ä¢ Concepts ‚Ä¢ Practice</span>
      </div>
      <div class="header-actions">
        <button class="action-btn clear-btn" id="clearChatBtn">üóëÔ∏è Clear Chat</button>
        <button class="action-btn" id="openApiDialog">üîë API Key</button>
        <button class="action-btn" id="openHistoryBtn">üìú History</button>
        <button class="action-btn" id="openPersonaBtn">üé≠ Persona</button>
        <button class="action-btn" id="openVoiceBtn">üîä Voice</button>
        <button class="action-btn" id="openUploadBtn">üìÅ Upload</button>
        <button class="mode-toggle" id="modeToggleBtn">
          <span id="modeIcon">üåê</span>
          <span id="modeText">Online-Only</span>
        </button>
      </div>
    </header>

    <!-- Chat area -->
    <div id="chat" class="chat">
      <div class="msg ai">
        <div class="formatted-text">
          <p>Hello! I'm Ramanujan School AI, created by students of Ramanujan Public School in Prayagraj, Jhalwa. I'll remember our conversation as we chat.</p>
          <p><strong>New Features:</strong></p>
          <ul>
            <li>Microphone input - Click üé§ to speak</li>
            <li>Voice output - Choose from male/female voices</li>
            <li>Chat history and persona settings</li>
            <li>File upload support (text files)</li>
            <li>Toggle between offline and online-only modes</li>
            <li>Properly formatted responses with spacing and lists</li>
            <li>Conversation memory for context-aware answers</li>
          </ul>
          <p><strong>Current Mode:</strong> <span id="currentModeDisplay">Online-Only Mode</span></p>
          <p>In online-only mode, all questions go directly to the AI API for comprehensive answers.</p>
          <p>Ask me anything! üôÇ</p>
        </div>
      </div>
    </div>

    <!-- Footer with input and microphone -->
    <footer>
      <div class="input">
        <input id="q" placeholder="Type your question or click üé§ to speak..." />
        <button class="mic-btn" id="micBtn">üé§</button>
        <button id="send">Send</button>
      </div>
      <div class="hint">
        <span>
          <span id="modeIndicator">üî¥ Offline Mode</span>
          <span id="onlineModeStatus" class="mode-status online-only" style="display: none;">üåê Online-Only</span>
          <span id="offlineModeStatus" class="mode-status offline">üìö Offline Enabled</span>
        </span>
        <span>
          <button class="credits-btn" id="openCreditsDialog">Credits</button>
        </span>
      </div>
    </footer>
  </div>

  <!-- ===== ALL DIALOGS ===== -->
  
  <!-- API Key Dialog -->
  <div id="apiDialog" class="api-dialog">
    <button class="close-dialog" id="closeApiDialog">√ó</button>
    <h3>Groq API Key</h3>
    <div class="api-input-container">
      <input type="password" id="apiInput" class="api-input" placeholder="Enter your API key..." />
      <button id="saveKey" class="small">Save</button>
    </div>
    <div id="apiStatus" class="api-status">
      Status: No API key saved
    </div>
    <div class="api-actions">
      <button id="clearKey" class="secondary">Clear Key</button>
      <button id="testKey" class="secondary">Test Key</button>
    </div>
    <div class="api-help">
      Get your free API key from
      <a href="https://console.groq.com" target="_blank">Groq Console</a>.
      Keys are stored locally in your browser only.
    </div>
  </div>

  <!-- Credits Dialog -->
  <div id="creditsDialog" class="credits-dialog">
    <button class="close-dialog" id="closeCreditsDialog">√ó</button>
    <h3>Project Credits</h3>
    <div class="credits-content">
      <p>This AI Assistant was developed with the assistance of <strong>DeepSeek AI</strong>, which provided coding guidance and implementation support.</p>
      
      <p>The AI capabilities are powered by <strong>Groq Cloud API</strong> through the Groq Console, providing fast and efficient language model processing.</p>
      
      <p>All code was written by students of <strong>Class IX-B, Ramanujan Public School, Prayagraj, Jhalwa</strong> as an educational project.</p>
      
      <p>Features include:</p>
      <ul>
        <li>Microphone voice input with real-time transcription</li>
        <li>Text-to-speech output with male/female voice selection</li>
        <li>Chat history with search and clear options</li>
        <li>Custom persona settings for AI behavior</li>
        <li>File upload and text extraction</li>
        <li>Conversation memory for context-aware responses</li>
        <li>Toggle between offline and online-only modes</li>
        <li>Local browser storage for API keys</li>
        <li>Responsive design for all devices</li>
        <li>Properly formatted responses with spacing and lists</li>
      </ul>
      
      <p><strong>Team Members:</strong> Priyansh (Developer & Presenter), Vansh, Shreyash, Shreya, Anshika, Ananya, Ankit, Kashfa, Utkarshini (All Presenters)</p>
    </div>
    <button class="credits-close" id="closeCreditsBtn">Close</button>
  </div>

  <!-- History Dialog -->
  <div id="historyDialog" class="history-dialog">
    <button class="close-dialog" id="closeHistoryDialog">√ó</button>
    <h3>Chat History</h3>
    <div id="historyContent" class="dialog-content">
      <!-- History items will be loaded here -->
    </div>
    <div class="dialog-actions">
      <button id="clearHistoryBtn" class="secondary">Clear History</button>
      <button id="closeHistoryBtn" class="credits-close">Close</button>
    </div>
  </div>

  <!-- Persona Dialog -->
  <div id="personaDialog" class="persona-dialog">
    <button class="close-dialog" id="closePersonaDialog">√ó</button>
    <h3>AI Persona Settings</h3>
    <div class="credits-content">
      <p>How should the AI respond?</p>
      <textarea id="personaInput" class="persona-input" placeholder="Example: You are a friendly math tutor. Explain concepts simply with examples. Use bullet points for clarity. Keep answers concise."></textarea>
      <small style="color: var(--muted); display: block; margin-top: 5px;">These instructions will be added to every AI request.</small>
    </div>
    <div class="dialog-actions">
      <button id="clearPersonaBtn" class="secondary">Clear</button>
      <button id="savePersonaBtn" class="credits-close">Save Persona</button>
    </div>
  </div>

  <!-- Voice Settings Dialog -->
  <div id="voiceDialog" class="voice-dialog">
    <button class="close-dialog" id="closeVoiceDialog">√ó</button>
    <h3>Voice Settings</h3>
    <div class="credits-content">
      <p>Select a voice for text-to-speech output:</p>
      <div class="voice-options" id="voiceOptions">
        <!-- Voice options will be added here -->
      </div>
      <div style="margin-top: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="autoSpeakToggle">
          <span>Automatically speak AI responses</span>
        </label>
        <small style="color: var(--muted); display: block; margin-top: 5px;">When enabled, AI responses will be read aloud automatically.</small>
      </div>
      <div style="margin-top: 15px;">
        <button id="testVoiceBtn" class="audio-btn" style="width: 100%;">Test Selected Voice</button>
      </div>
    </div>
    <button class="credits-close" id="closeVoiceBtn">Close</button>
  </div>

  <!-- Upload Dialog -->
  <div id="uploadDialog" class="upload-dialog">
    <button class="close-dialog" id="closeUploadDialog">√ó</button>
    <h3>File Upload</h3>
    <div class="credits-content">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">Drop files here or click to browse</div>
        <div class="upload-subtext">Supported: .txt, .pdf, .doc, .docx (Max 5MB)</div>
      </div>
      <input type="file" id="fileInput" multiple style="display: none;">
      
      <div class="uploaded-files" id="uploadedFiles">
        <!-- Uploaded files will be listed here -->
      </div>
      
      <div style="margin-top: 20px;">
        <small style="color: var(--muted);">
          Uploaded files will be extracted as text and can be referenced in conversations.
          Files are stored in your browser's local storage.
        </small>
      </div>
    </div>
    <div class="dialog-actions">
      <button id="clearFilesBtn" class="secondary">Clear All Files</button>
      <button id="closeUploadBtn" class="credits-close">Close</button>
    </div>
  </div>

<script>
  /* ===== STARTUP SCREEN LOGIC ===== */
  let currentSlide = 0;
  const slides = document.querySelectorAll('.startup-slide');

  function showNextSlide() {
    slides[currentSlide].classList.remove('active');
    currentSlide++;
    if (currentSlide < slides.length) {
      slides[currentSlide].classList.add('active');
    } else {
      startChatApp();
    }
  }

  function startChatApp() {
    const startupScreen = document.getElementById('startupScreen');
    startupScreen.style.opacity = '0';
    startupScreen.style.transform = 'scale(1.05)';
    startupScreen.style.transition = 'opacity 0.6s ease, transform 0.6s ease';

    setTimeout(() => {
      startupScreen.style.display = 'none';
      document.getElementById('mainApp').style.display = 'grid';
      document.getElementById('q').focus();
      initVoiceSettings(); // Initialize voice settings
    }, 600);
  }

  /* ===== TEXT FORMATTING FUNCTION ===== */
  function formatTextForDisplay(text) {
    if (/<[a-z][\s\S]*>/i.test(text)) {
      return text;
    }
    
    let formattedText = text;
    
    // Replace markdown-style formatting
    formattedText = formattedText.replace(/^### (.*$)/gim, '<h4>$1</h4>');
    formattedText = formattedText.replace(/^## (.*$)/gim, '<h3>$1</h3>');
    formattedText = formattedText.replace(/^# (.*$)/gim, '<h3>$1</h3>');
    
    formattedText = formattedText.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    formattedText = formattedText.replace(/^(\d+)\.\s+(.*$)/gim, '<li><strong>$1.</strong> $2</li>');
    formattedText = formattedText.replace(/^[\*\-\‚Ä¢]\s+(.*$)/gim, '<li>$1</li>');
    
    if (formattedText.includes('<li>')) {
      if (formattedText.match(/^<li><strong>\d+\./)) {
        formattedText = formattedText.replace(/<li>/g, '<li>');
        formattedText = '<ol>' + formattedText + '</ol>';
      } else {
        formattedText = '<ul>' + formattedText + '</ul>';
      }
    }
    
    formattedText = formattedText.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    let paragraphs = formattedText.split(/\n\s*\n/);
    
    paragraphs = paragraphs.map(para => {
      para = para.trim();
      if (!para) return '';
      
      if (para.startsWith('<')) {
        return para;
      }
      
      if (para.length < 100 && (para.includes('<h') || para.includes('<li>'))) {
        return para;
      }
      
      return '<p>' + para + '</p>';
    });
    
    formattedText = paragraphs.filter(p => p).join('');
    formattedText = formattedText.replace(/\n/g, '<br>');
    
    return '<div class="formatted-text">' + formattedText + '</div>';
  }

  /* ===== MAIN APPLICATION ===== */
  
  // Conversation memory system
  class ConversationMemory {
    constructor(maxMessages = 20) {
      this.maxMessages = maxMessages;
      this.messages = [];
      this.loadFromStorage();
    }
    
    addMessage(role, content) {
      this.messages.push({ role, content, timestamp: Date.now() });
      this.trimMemory();
      this.saveToStorage();
    }
    
    getContextMessages() {
      return this.messages.slice(-this.maxMessages);
    }
    
    getFullHistory() {
      return this.messages;
    }
    
    clear() {
      this.messages = [];
      localStorage.removeItem('chat_memory');
    }
    
    trimMemory() {
      if (this.messages.length > this.maxMessages) {
        this.messages = this.messages.slice(-this.maxMessages);
      }
    }
    
    saveToStorage() {
      try {
        localStorage.setItem('chat_memory', JSON.stringify(this.messages));
      } catch (e) {
        console.warn('Could not save chat memory:', e);
      }
    }
    
    loadFromStorage() {
      try {
        const saved = localStorage.getItem('chat_memory');
        if (saved) {
          this.messages = JSON.parse(saved);
          this.trimMemory();
        }
      } catch (e) {
        console.warn('Could not load chat memory:', e);
      }
    }
    
    getMessageCount() {
      return this.messages.length;
    }
  }

  // File storage system
  class FileStorage {
    constructor() {
      this.files = [];
      this.loadFromStorage();
    }
    
    addFile(name, content, size) {
      const file = {
        id: Date.now().toString(),
        name,
        content,
        size,
        uploaded: Date.now()
      };
      this.files.push(file);
      this.saveToStorage();
      return file;
    }
    
    removeFile(id) {
      this.files = this.files.filter(file => file.id !== id);
      this.saveToStorage();
    }
    
    clearAll() {
      this.files = [];
      localStorage.removeItem('uploaded_files');
    }
    
    getFiles() {
      return this.files;
    }
    
    saveToStorage() {
      try {
        localStorage.setItem('uploaded_files', JSON.stringify(this.files));
      } catch (e) {
        console.warn('Could not save files:', e);
      }
    }
    
    loadFromStorage() {
      try {
        const saved = localStorage.getItem('uploaded_files');
        if (saved) {
          this.files = JSON.parse(saved);
        }
      } catch (e) {
        console.warn('Could not load files:', e);
      }
    }
  }

  // Initialize systems
  const conversationMemory = new ConversationMemory(20);
  const fileStorage = new FileStorage();
  
  // Global variables
  let GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
  let OFFLINE_MODE_ENABLED = localStorage.getItem('OFFLINE_MODE_ENABLED') !== 'false';
  let selectedVoice = localStorage.getItem('selected_voice') || 'female-1';
  let autoSpeak = localStorage.getItem('auto_speak') === 'true';
  let currentPersona = localStorage.getItem('AI_PERSONA') || '';
  
  // Speech synthesis
  let speechSynthesis = window.speechSynthesis;
  let voices = [];
  let currentUtterance = null;

  // DOM Elements
  const dialogOverlay = document.getElementById('dialogOverlay');
  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const send = document.getElementById('send');
  const micBtn = document.getElementById('micBtn');
  
  // Dialog elements
  const dialogs = {
    api: document.getElementById('apiDialog'),
    credits: document.getElementById('creditsDialog'),
    history: document.getElementById('historyDialog'),
    persona: document.getElementById('personaDialog'),
    voice: document.getElementById('voiceDialog'),
    upload: document.getElementById('uploadDialog')
  };
  
  // Initialize UI
  function initVoiceSettings() {
    // Load available voices
    voices = speechSynthesis.getVoices();
    
    // If voices aren't loaded yet, wait for them
    if (voices.length === 0) {
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        populateVoiceOptions();
      };
    } else {
      populateVoiceOptions();
    }
    
    // Set auto-speak toggle
    document.getElementById('autoSpeakToggle').checked = autoSpeak;
    
    // Set persona input
    document.getElementById('personaInput').value = currentPersona;
    
    // Load uploaded files display
    updateUploadedFilesDisplay();
  }

  function populateVoiceOptions() {
    const voiceOptions = document.getElementById('voiceOptions');
    voiceOptions.innerHTML = '';
    
    // Create custom voice options (using browser voices)
    const customVoices = [
      { id: 'female-1', name: 'Female Voice 1', type: 'Female', lang: 'en-US' },
      { id: 'female-2', name: 'Female Voice 2', type: 'Female', lang: 'en-GB' },
      { id: 'male-1', name: 'Male Voice 1', type: 'Male', lang: 'en-US' },
      { id: 'male-2', name: 'Male Voice 2', type: 'Male', lang: 'en-GB' }
    ];
    
    customVoices.forEach(voice => {
      const option = document.createElement('div');
      option.className = `voice-option ${selectedVoice === voice.id ? 'selected' : ''}`;
      option.innerHTML = `
        <input type="radio" name="voice" value="${voice.id}" ${selectedVoice === voice.id ? 'checked' : ''}>
        <div class="voice-label">
          <div class="voice-name">${voice.name}</div>
          <div class="voice-type">${voice.type} ‚Ä¢ ${voice.lang}</div>
        </div>
      `;
      
      option.querySelector('input').addEventListener('change', (e) => {
        selectedVoice = e.target.value;
        localStorage.setItem('selected_voice', selectedVoice);
        
        // Update selected state
        document.querySelectorAll('.voice-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
      });
      
      voiceOptions.appendChild(option);
    });
  }

  // Speech functions
  function speakText(text) {
    if (!autoSpeak || !speechSynthesis) return;
    
    // Stop any current speech
    if (currentUtterance) {
      speechSynthesis.cancel();
    }
    
    // Clean text for speech (remove markdown, etc.)
    const cleanText = text
      .replace(/[#*`\[\]]/g, '')
      .replace(/\n/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    
    if (!cleanText) return;
    
    currentUtterance = new SpeechSynthesisUtterance(cleanText);
    
    // Set voice based on selection
    const availableVoices = speechSynthesis.getVoices();
    
    // Try to find a matching voice
    let voiceToUse = null;
    if (selectedVoice.includes('female')) {
      voiceToUse = availableVoices.find(v => 
        v.lang.includes('en') && v.name.toLowerCase().includes('female')
      ) || availableVoices.find(v => v.lang.includes('en'));
    } else {
      voiceToUse = availableVoices.find(v => 
        v.lang.includes('en') && v.name.toLowerCase().includes('male')
      ) || availableVoices.find(v => v.lang.includes('en'));
    }
    
    if (voiceToUse) {
      currentUtterance.voice = voiceToUse;
    }
    
    currentUtterance.rate = 1.0;
    currentUtterance.pitch = 1.0;
    currentUtterance.volume = 1.0;
    
    speechSynthesis.speak(currentUtterance);
  }

  function stopSpeaking() {
    if (speechSynthesis && speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
  }

  // Voice recognition
  let recognition = null;
  let isListening = false;

  function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onstart = () => {
        isListening = true;
        micBtn.classList.add('listening');
        micBtn.textContent = 'üî¥';
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        q.value = transcript;
        micBtn.classList.remove('listening');
        micBtn.textContent = 'üé§';
        isListening = false;
        
        // Auto-send if it sounds like a question
        if (transcript.trim().endsWith('?')) {
          setTimeout(() => ask(), 500);
        }
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        micBtn.classList.remove('listening');
        micBtn.textContent = 'üé§';
        isListening = false;
        
        if (event.error === 'not-allowed') {
          addMessageToChat('Microphone access was denied. Please allow microphone access in your browser settings.', 'ai');
        }
      };
      
      recognition.onend = () => {
        if (isListening) {
          // Restart if still supposed to be listening
          setTimeout(() => recognition.start(), 100);
        } else {
          micBtn.classList.remove('listening');
          micBtn.textContent = 'üé§';
        }
      };
    } else {
      micBtn.style.display = 'none';
      addMessageToChat('Speech recognition is not supported in your browser. Try Chrome or Edge.', 'ai');
    }
  }

  // Microphone button handler
  micBtn.onclick = () => {
    if (!recognition) {
      initVoiceRecognition();
      return;
    }
    
    if (isListening) {
      recognition.stop();
      isListening = false;
      micBtn.classList.remove('listening');
      micBtn.textContent = 'üé§';
    } else {
      try {
        recognition.start();
      } catch (e) {
        console.error('Failed to start recognition:', e);
        addMessageToChat('Failed to start microphone. Please check permissions.', 'ai');
      }
    }
  };

  // Update mode UI
  function updateModeUI() {
    const modeToggleBtn = document.getElementById('modeToggleBtn');
    const modeIcon = document.getElementById('modeIcon');
    const modeText = document.getElementById('modeText');
    const currentModeDisplay = document.getElementById('currentModeDisplay');
    const onlineModeStatus = document.getElementById('onlineModeStatus');
    const offlineModeStatus = document.getElementById('offlineModeStatus');
    const modeIndicator = document.getElementById('modeIndicator');

    if (OFFLINE_MODE_ENABLED) {
      modeToggleBtn.classList.remove('online-mode');
      modeIcon.textContent = 'üåê';
      modeText.textContent = 'Online-Only';
      currentModeDisplay.textContent = 'Hybrid Mode (Offline + Online)';
      onlineModeStatus.style.display = 'none';
      offlineModeStatus.style.display = 'inline-flex';
      modeIndicator.textContent = 'üü¢ Hybrid Mode';
      modeIndicator.style.color = '#6cf2c2';
    } else {
      modeToggleBtn.classList.add('online-mode');
      modeIcon.textContent = 'üìö';
      modeText.textContent = 'Offline Mode';
      currentModeDisplay.textContent = 'Online-Only Mode';
      onlineModeStatus.style.display = 'inline-flex';
      offlineModeStatus.style.display = 'none';
      modeIndicator.textContent = 'üåê Online-Only';
      modeIndicator.style.color = '#7aa2ff';
    }
  }

  // Update API status
  function updateApiStatus() {
    const apiStatus = document.getElementById('apiStatus');
    if (GROQ_API_KEY) {
      const maskedKey = `${GROQ_API_KEY.substring(0, 10)}...${GROQ_API_KEY.substring(GROQ_API_KEY.length - 4)}`;
      apiStatus.textContent = `‚úÖ API Key saved: ${maskedKey}`;
      apiStatus.className = 'api-status valid';
    } else {
      apiStatus.textContent = 'üî¥ No API key saved (Offline mode only)';
      apiStatus.className = 'api-status invalid';
    }
  }

  // Dialog management
  function showDialog(dialogName) {
    // Hide all dialogs first
    Object.values(dialogs).forEach(dialog => {
      dialog.classList.remove('show');
    });
    
    // Show overlay and selected dialog
    dialogOverlay.classList.add('show');
    dialogs[dialogName].classList.add('show');
  }

  function hideAllDialogs() {
    dialogOverlay.classList.remove('show');
    Object.values(dialogs).forEach(dialog => {
      dialog.classList.remove('show');
    });
  }

  // Initialize event listeners
  function initEventListeners() {
    // Dialog open buttons
    document.getElementById('openApiDialog').onclick = () => showDialog('api');
    document.getElementById('openCreditsDialog').onclick = () => showDialog('credits');
    document.getElementById('openHistoryBtn').onclick = () => {
      loadHistory();
      showDialog('history');
    };
    document.getElementById('openPersonaBtn').onclick = () => {
      document.getElementById('personaInput').value = currentPersona;
      showDialog('persona');
    };
    document.getElementById('openVoiceBtn').onclick = () => showDialog('voice');
    document.getElementById('openUploadBtn').onclick = () => {
      updateUploadedFilesDisplay();
      showDialog('upload');
    };
    
    // Dialog close buttons
    document.getElementById('closeApiDialog').onclick = hideAllDialogs;
    document.getElementById('closeCreditsDialog').onclick = hideAllDialogs;
    document.getElementById('closeCreditsBtn').onclick = hideAllDialogs;
    document.getElementById('closeHistoryDialog').onclick = hideAllDialogs;
    document.getElementById('closeHistoryBtn').onclick = hideAllDialogs;
    document.getElementById('closePersonaDialog').onclick = hideAllDialogs;
    document.getElementById('closeVoiceDialog').onclick = hideAllDialogs;
    document.getElementById('closeVoiceBtn').onclick = hideAllDialogs;
    document.getElementById('closeUploadDialog').onclick = hideAllDialogs;
    document.getElementById('closeUploadBtn').onclick = hideAllDialogs;
    
    // Overlay click
    dialogOverlay.onclick = hideAllDialogs;
    
    // Mode toggle
    document.getElementById('modeToggleBtn').onclick = () => {
      OFFLINE_MODE_ENABLED = !OFFLINE_MODE_ENABLED;
      localStorage.setItem('OFFLINE_MODE_ENABLED', OFFLINE_MODE_ENABLED);
      updateModeUI();
      
      const modeMessage = OFFLINE_MODE_ENABLED 
        ? 'Switched to Hybrid Mode: I will use offline knowledge for simple queries and online AI for complex questions.' 
        : 'Switched to Online-Only Mode: All queries will be sent to the AI API for comprehensive answers.';
      
      addMessageToChat(modeMessage, 'ai');
    };
    
    // Clear chat button
    document.getElementById('clearChatBtn').onclick = () => {
      if (confirm('Clear all chat messages and conversation memory?')) {
        chat.innerHTML = '<div class="msg ai"><div class="formatted-text"><p>Hello! I\'m Ramanujan School AI, created by students of Ramanujan Public School in Prayagraj, Jhalwa. I\'ll remember our conversation as we chat.</p><p><strong>New Features:</strong></p><ul><li>Microphone input - Click üé§ to speak</li><li>Voice output - Choose from male/female voices</li><li>Chat history and persona settings</li><li>File upload support (text files)</li><li>Toggle between offline and online-only modes</li><li>Properly formatted responses with spacing and lists</li><li>Conversation memory for context-aware answers</li></ul><p><strong>Current Mode:</strong> <span id="currentModeDisplay">' + (OFFLINE_MODE_ENABLED ? 'Hybrid Mode (Offline + Online)' : 'Online-Only Mode') + '</span></p><p>' + (OFFLINE_MODE_ENABLED ? 'In hybrid mode, simple queries use offline knowledge and complex ones use AI API.' : 'In online-only mode, all questions go directly to the AI API for comprehensive answers.') + '</p><p>Ask me anything! üôÇ</p></div></div>';
        conversationMemory.clear();
      }
    };
    
    // API Key management
    document.getElementById('saveKey').onclick = () => {
      const apiInput = document.getElementById('apiInput');
      const v = apiInput.value.trim();
      if (v) {
        if (v.length < 20) {
          apiStatus.textContent = '‚ùå Key seems too short. Please check.';
          apiStatus.className = 'api-status invalid';
          return;
        }
        localStorage.setItem('GROQ_API_KEY', v);
        GROQ_API_KEY = v;
        updateApiStatus();
        hideAllDialogs();
        addMessageToChat('Groq API key saved successfully! You can now use online features.', 'ai');
      }
    };
    
    document.getElementById('clearKey').onclick = () => {
      localStorage.removeItem('GROQ_API_KEY');
      GROQ_API_KEY = null;
      document.getElementById('apiInput').value = '';
      updateApiStatus();
      addMessageToChat('API key cleared. Switching to offline mode only.', 'ai');
    };
    
    document.getElementById('testKey').onclick = async () => {
      if (!GROQ_API_KEY) {
        apiStatus.textContent = '‚ùå No API key to test';
        apiStatus.className = 'api-status invalid';
        return;
      }
      apiStatus.textContent = 'üîÑ Testing Groq API key...';
      apiStatus.className = 'api-status';
      try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GROQ_API_KEY}`
          },
          body: JSON.stringify({
            messages: [{ role: 'user', content: 'Say "API test successful" if you can read this.' }],
            model: 'llama-3.1-8b-instant',
            max_tokens: 20
          })
        });
        if (response.ok) {
          apiStatus.textContent = '‚úÖ Groq API key is working!';
          apiStatus.className = 'api-status valid';
        } else {
          const error = await response.json();
          let errorMsg = `‚ùå API error: ${error.error?.message || 'Unknown error'}`;
          apiStatus.textContent = errorMsg;
          apiStatus.className = 'api-status invalid';
        }
      } catch (err) {
        apiStatus.textContent = '‚ùå Network error - check connection';
        apiStatus.className = 'api-status invalid';
      }
    };
    
    // Persona settings
    document.getElementById('savePersonaBtn').onclick = () => {
      const persona = document.getElementById('personaInput').value.trim();
      if (persona) {
        localStorage.setItem('AI_PERSONA', persona);
        currentPersona = persona;
        addMessageToChat('AI persona settings saved! The AI will now respond according to your instructions.', 'ai');
      } else {
        localStorage.removeItem('AI_PERSONA');
        currentPersona = '';
        addMessageToChat('AI persona settings cleared. Using default behavior.', 'ai');
      }
      hideAllDialogs();
    };
    
    document.getElementById('clearPersonaBtn').onclick = () => {
      document.getElementById('personaInput').value = '';
    };
    
    // Voice settings
    document.getElementById('autoSpeakToggle').onchange = (e) => {
      autoSpeak = e.target.checked;
      localStorage.setItem('auto_speak', autoSpeak);
    };
    
    document.getElementById('testVoiceBtn').onclick = () => {
      speakText('This is a test of the selected voice. The text to speech system is working correctly.');
    };
    
    // History
    document.getElementById('clearHistoryBtn').onclick = () => {
      if (confirm('Clear all chat history?')) {
        conversationMemory.clear();
        loadHistory();
      }
    };
    
    // File upload
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.onclick = () => fileInput.click();
    
    fileInput.onchange = handleFileUpload;
    
    uploadArea.ondragover = (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    };
    
    uploadArea.ondragleave = () => {
      uploadArea.classList.remove('dragover');
    };
    
    uploadArea.ondrop = (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFileUpload({ target: { files: e.dataTransfer.files } });
    };
    
    document.getElementById('clearFilesBtn').onclick = () => {
      if (confirm('Clear all uploaded files?')) {
        fileStorage.clearAll();
        updateUploadedFilesDisplay();
      }
    };
    
    // Send button and input
    send.onclick = ask;
    q.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ask();
      }
    });
  }

  // File upload handling
  async function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    
    for (const file of files) {
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        addMessageToChat(`File "${file.name}" is too large (max 5MB)`, 'ai');
        continue;
      }
      
      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          let content = e.target.result;
          
          // For text files, use as-is
          if (file.type === 'text/plain') {
            // Content is already text
          } else if (file.type === 'application/pdf') {
            // PDF extraction would require a library
            content = `[PDF file: ${file.name}] - Please upgrade to extract text from PDF files.`;
          } else if (file.type.includes('document')) {
            // Word document
            content = `[Document: ${file.name}] - Text extraction for documents requires additional libraries.`;
          } else {
            content = `[File: ${file.name}] - Unsupported file type.`;
          }
          
          fileStorage.addFile(file.name, content, file.size);
          updateUploadedFilesDisplay();
          addMessageToChat(`File "${file.name}" uploaded successfully. You can now ask questions about its content.`, 'ai');
        } catch (error) {
          console.error('Error reading file:', error);
          addMessageToChat(`Error reading file "${file.name}"`, 'ai');
        }
      };
      
      reader.onerror = () => {
        addMessageToChat(`Error reading file "${file.name}"`, 'ai');
      };
      
      if (file.type === 'text/plain') {
        reader.readAsText(file);
      } else {
        reader.readAsDataURL(file);
      }
    }
    
    // Reset file input
    fileInput.value = '';
  }

  function updateUploadedFilesDisplay() {
    const uploadedFilesDiv = document.getElementById('uploadedFiles');
    const files = fileStorage.getFiles();
    
    if (files.length === 0) {
      uploadedFilesDiv.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No files uploaded yet</div>';
      return;
    }
    
    let html = '';
    files.forEach(file => {
      const size = formatFileSize(file.size);
      html += `
        <div class="uploaded-file">
          <div>
            <div class="file-name">${file.name}</div>
            <div class="file-size">${size} ‚Ä¢ ${new Date(file.uploaded).toLocaleDateString()}</div>
          </div>
          <button class="remove-file" onclick="removeFile('${file.id}')">√ó</button>
        </div>
      `;
    });
    
    uploadedFilesDiv.innerHTML = html;
  }

  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  function removeFile(id) {
    fileStorage.removeFile(id);
    updateUploadedFilesDisplay();
  }

  // History loading
  function loadHistory() {
    const historyContent = document.getElementById('historyContent');
    const messages = conversationMemory.getFullHistory();
    
    if (messages.length === 0) {
      historyContent.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No chat history yet</div>';
      return;
    }
    
    let html = '';
    messages.forEach((msg, index) => {
      const time = new Date(msg.timestamp).toLocaleString();
      const role = msg.role === 'user' ? 'üë§ You' : 'ü§ñ AI';
      const content = msg.content.length > 150 ? msg.content.substring(0, 150) + '...' : msg.content;
      
      html += `
        <div class="history-item">
          <div class="history-header">
            <div class="history-role">${role}</div>
            <div class="history-time">${time}</div>
          </div>
          <div class="history-content">${content.replace(/\n/g, ' ')}</div>
        </div>
      `;
    });
    
    historyContent.innerHTML = html;
  }

  // Knowledge base
  const SCHOOL_KB = `Ramanujan Public School is a co-educational English-medium senior secondary school located in Jhalwa, Prayagraj (formerly Allahabad), Uttar Pradesh, India. It's affiliated with the Central Board of Secondary Education (CBSE) and offers classes from nursery up to class 12.

üè´ About the School
‚Ä¢ Founded: 1995 AD
‚Ä¢ Location: Sahapur Urf Peepalgaon, Opposite IIIT, Jhalwa, Prayagraj ‚Äì 211012, Uttar Pradesh
‚Ä¢ Affiliation: CBSE (Affiliation number 2130472)
‚Ä¢ Contact: Phone: +91-7752922226, Email: rpsjhalwa.all@gmail.com

üìå Founders / Managing Organization
Ramanujan Public School was established by the Brij Nath Dina Nath (BNDN) Memorial Educational Society in memory of Lt. Brij Nath and Lt. Dr. Dina Nath. It was founded under the leadership of Dr. Gyan Chandra Srivastava, who is the Founder and Chairman of the Ramanujan Group of Educational Institutions (RGEI), which manages the school.

This AI assistant was created by students of Class IX-B of Ramanujan Public School as an educational project.`;

  const JAGANNATH_KB = `Lord Jagannath is a revered form of Lord Vishnu/Krishna, worshipped primarily in Odisha, India.
He is traditionally worshipped along with his siblings: Lord Balabhadra and Devi Subhadra.
Jagannath Puri Temple is one of the Char Dham pilgrimage sites of Hinduism and is located in Puri, Odisha.
A unique feature of Jagannath worship is the wooden idols (daru brahma), which are ritually renewed in the Nabakalebara ceremony.
The annual Rath Yatra is a major festival where the deities are taken out on massive chariots for public darshan.
Jagannath symbolizes universality, compassion, and inclusiveness.`;

  const MATH_KB = {
    'pythagoras': 'The Pythagorean theorem states: a¬≤ + b¬≤ = c¬≤, where c is the hypotenuse of a right triangle.',
    'quadratic': 'The quadratic formula: x = [-b ¬± ‚àö(b¬≤ - 4ac)] / 2a',
    'algebra': 'Algebra is the branch of mathematics dealing with symbols and rules for manipulating those symbols.',
    'geometry': 'Geometry studies shapes, sizes, positions, and properties of space.',
    'calculus': 'Calculus is the mathematical study of continuous change.',
    'trigonometry': 'Trigonometry deals with relationships between angles and sides of triangles.',
    'statistics': 'Statistics is the study of data collection, analysis, interpretation, and presentation.',
    'probability': 'Probability measures the likelihood of events occurring.'
  };

  // Offline reply function
  function offlineReply(text) {
    if (!OFFLINE_MODE_ENABLED) return null;
    
    text = text.toLowerCase().trim();
    
    // Basic greetings
    if (/^(hi|hello|hey|namaste)/i.test(text)) return 'Hello! How may I assist you with your studies today?';
    if (/how are you/i.test(text)) return 'I am functioning well. Ready to help with your questions!';
    if (/what is your name/i.test(text)) return 'I am Ramanujan School AI, created by students of Class IX-B at Ramanujan Public School.';
    if (/who created you/i.test(text)) return 'I was created by students of Class IX-B at Ramanujan Public School, Prayagraj.';
    
    // School queries
    if (text.includes('ramanujan school') || text.includes('ramanujan public school') || 
        text.includes('school in jhalwa') || text.includes('rps jhalwa') ||
        text.includes('ramanujan') && text.includes('school')) {
      return SCHOOL_KB;
    }
    
    // Jagannath queries
    if (/jagannath|puri temple|rath yatra/i.test(text)) return JAGANNATH_KB;
    
    // Math terms
    const mathTerms = ['pythagoras', 'quadratic', 'algebra', 'geometry', 'calculus', 'trigonometry', 'statistics', 'probability'];
    for (const term of mathTerms) {
      if (text.includes(term) && text.split(' ').length < 5) {
        return MATH_KB[term] || null;
      }
    }
    
    // Check uploaded files
    if (text.includes('uploaded file') || text.includes('my file') || text.includes('attached file')) {
      const files = fileStorage.getFiles();
      if (files.length > 0) {
        return `You have ${files.length} uploaded file(s). To ask about a specific file, mention its name or ask about the content directly.`;
      }
    }
    
    return null;
  }

  // Add message to chat
  function addMessageToChat(text, cls, isTyping = false) {
    const d = document.createElement('div');
    d.className = `msg ${cls}`;
    
    if (isTyping) {
      d.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      d.id = 'typing-msg';
    } else {
      d.innerHTML = formatTextForDisplay(text);
      
      // Add audio button for AI messages
      if (cls === 'ai' && autoSpeak) {
        const audioBtn = document.createElement('button');
        audioBtn.className = 'audio-btn';
        audioBtn.innerHTML = 'üîä';
        audioBtn.style.marginLeft = '10px';
        audioBtn.onclick = () => speakText(text);
        d.querySelector('.formatted-text').appendChild(audioBtn);
      }
    }
    
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return d;
  }

  function removeTypingIndicator() {
    const typingMsg = document.getElementById('typing-msg');
    if (typingMsg) typingMsg.remove();
  }

  // Main ask function
  async function ask() {
    const text = q.value.trim();
    if (!text) return;
    
    q.value = '';
    
    // Add user message to chat and memory
    addMessageToChat(text, 'user');
    conversationMemory.addMessage('user', text);
    
    send.disabled = true;
    q.disabled = true;
    micBtn.disabled = true;

    let typingIndicator = null;
    
    // Check for offline reply first
    if (OFFLINE_MODE_ENABLED) {
      const localReply = offlineReply(text);
      if (localReply) {
        typingIndicator = addMessageToChat('', 'ai', true);
        
        setTimeout(() => {
          removeTypingIndicator();
          addMessageToChat(localReply, 'ai');
          conversationMemory.addMessage('assistant', localReply);
          speakText(localReply);
          send.disabled = false;
          q.disabled = false;
          micBtn.disabled = false;
          q.focus();
        }, 500);
        return;
      }
    }

    // If no API key but we need online mode
    if (!GROQ_API_KEY && !OFFLINE_MODE_ENABLED) {
      addMessageToChat('To use online features, please add your Groq API key by clicking the "API Key" button in the top right.', 'ai');
      send.disabled = false;
      q.disabled = false;
      micBtn.disabled = false;
      q.focus();
      showDialog('api');
      return;
    }

    // If no API key and offline mode can't handle it
    if (!GROQ_API_KEY) {
      addMessageToChat('I couldn\'t find an answer in my offline knowledge. Please add an API key for online queries or ask simpler questions.', 'ai');
      send.disabled = false;
      q.disabled = false;
      micBtn.disabled = false;
      q.focus();
      return;
    }

    // Show typing indicator for online request
    typingIndicator = addMessageToChat('', 'ai', true);

    try {
      // Check uploaded files for context
      const files = fileStorage.getFiles();
      let fileContext = '';
      if (files.length > 0) {
        fileContext = '\n\nUser has uploaded these files that you can reference:\n';
        files.forEach((file, index) => {
          fileContext += `${index + 1}. ${file.name}: ${file.content.substring(0, 200)}...\n`;
        });
      }

      // Build system message with persona
      const systemMessage = currentPersona 
        ? `${currentPersona}\n\nYou are Ramanujan School AI created by students.${fileContext}\n\nIMPORTANT: When users ask about "CBSE", provide information about the educational board, not just the school.`
        : `You are Ramanujan School AI, a helpful assistant created by students of Ramanujan Public School in Prayagraj, Jhalwa.${fileContext}\n\nIMPORTANT: When users ask about "CBSE", provide information about the educational board, not just the school. Format answers with proper paragraphs, lists, and spacing. Use markdown formatting.`;

      // Build messages array with conversation history
      const contextMessages = conversationMemory.getContextMessages();
      const messages = [
        {
          role: 'system',
          content: systemMessage
        },
        ...contextMessages.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content
        })),
        {
          role: 'user',
          content: text
        }
      ];

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${GROQ_API_KEY}`
        },
        body: JSON.stringify({
          messages: messages,
          model: 'llama-3.1-8b-instant',
          temperature: 0.7,
          max_tokens: 1000
        })
      });
      
      removeTypingIndicator();
      
      if (!response.ok) {
        const error = await response.json();
        let errorMsg = '';
        if (error.error?.type === 'invalid_request_error') {
          errorMsg = '**API Key Error**\n\nPlease check your API key is valid.';
          updateApiStatus();
        } else if (error.error?.code === 'rate_limit_exceeded') {
          errorMsg = '**Rate Limit Reached**\n\nPlease wait a moment before sending more questions.';
        } else {
          errorMsg = `**Error**: ${error.error?.message || 'Unknown error'}`;
        }
        addMessageToChat(errorMsg, 'ai');
      } else {
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || 'I received an empty response. Please try again.';
        addMessageToChat(reply, 'ai');
        conversationMemory.addMessage('assistant', reply);
        speakText(reply);
      }
    } catch (err) {
      removeTypingIndicator();
      console.error('Request failed:', err);
      addMessageToChat('**Network Error**\n\nPlease check your connection and try again.', 'ai');
    }
    
    send.disabled = false;
    q.disabled = false;
    micBtn.disabled = false;
    q.focus();
  }

  // Initialize everything when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    updateApiStatus();
    updateModeUI();
    initEventListeners();
    initVoiceRecognition();
  });
</script>
</body>
</html>
